function [MedianSolutions,MeanSolutions,UpperQuantileSolutions,LowerQuantileSolutions,SensitivitySolutions] = CVB3ODEEval(MOI,varargin)
%Function: Stores all constants, initial values, runs the ODE, and calls other relevant functions
%
%INPUTS:
    %MOI: Simulated multiplicity of infection or the number of plaque forming units of virus. No default value.
    %PopulationSetting: Indicates whether or not to use a Poisson distribution for MOI or just a single cell. 'Single Cell' or 'Population' mode. Default = 'Single Cell'.
    %MaxTime (h): Maximum time for the solver in hours. Default = 16 h.
    %IFNSwitch: Indicates whether the host-cell anti-viral interferon (IFN) response is enabled. Default = 'on'.
    %VirResponse: Indicates whether the viral anti-interferon response is enabled. Default = 'on'.
    %IFNStimulation: Indicates if exogenous IFN stimulation is simulated. Default = 'off'.
    %IFNStimulationTime: If IFNStimulation is enabled, indicates the time at which exogenous IFN stimulation occurs. Negative in the case of pre-stimulation. Default = 0 h.
    %EC50_RNAdeg (nM): Half-effective concentration of ISG protein for viral RNA degradation. Default = 5 nM.
    %EC50_DetectorDeg (nM): Half-effective concentration of viral Protease for viral RNA detector degradation. Default = 1 pM.
    %EC50_Protease (nM): Half-effective concentration of ISG protein for inhibition of 2Apro by ISG15. Default = 20 nM.
    %EC50_Translate (nM): Half-effective concentration of ISG protein for translation inhibition. Default = 10 nM.
    %PlotResults: Indicates whether results plots are generated after simulations have completed. Default = 'on'.
    %PlotType: Specifies the type of axes to plot results on ('linear' or 'semilog'). Default = 'semilog'.
    %SensitivityAnalysis: Indicates whether sensitivity analysis is conducted on the model parameters. Default = 'off'.
    %SensitivityAnalysisOutput: Indicates the model species ('Plus RNA','Minus RNA','dsRNA','RNA Ratio','Polyprotein','Virion','Empty Provirion','Other') that is evaluated during sensitivity analysis. Default = 'Plus RNA'.
    %ScalingFactor: The factor by which each parameter is scaled during sensitivity analysis. Default = 10.
    %MaxScalingOrder: The integer absolute value of the maximum change to test via sensitivty analysis. Default = 2.
    %ExportData: Indicates whether the data should be exported as DataFile in the current working directory. Default = 'off'.
    %DataFile: A string specifying the name and type of file to be exported. The corresponding file will be written to the current working directory. Default = 'results.csv'.
    %RunCount: The number of times the model is simulated with parameters stochastically sampled from independent log-normal distributions. Default = 100.
    %UpperQuantile: The upper quantile outputted for model species. Default = 0.95.
    %LowerQuantile: The lower quantile outputted for model species. Default = 0.05.
    %CV: The coefficient of variation of the log-normal distribution the from which the parameters are stochastically determined. Default = 0.05.
%
%OUTPUTS:
    %MedianSolutions: A vector containing the median value of all model simulations from the ODE at a given time point.
    %MeanSolutons: A vector containing the mean value of all model simulations from the ODE at a given time point.
    %UpperQuantileSolutions: A vector containing the upper quantile value of all model simulations from the ODE at a given time point.
    %LowerQuantileSolutions: A vector containing the lower quantile value of all model simulations from the ODE at a given time point.
    %SensitivitySolutions: A vector containing the log2 fold change in SensitivityAnalysisOutput of all model simulations from the ODE at a given time point.
    
%% Set option defaults and parse inputs

%Set simulation parameter defaults
defaultMaxTime = 16; %hours
defaultPopulationSetting = 'Single Cell';
defaultIFNSwitch = 'on';
defaultVirResponse = 'on';
defaultIFNStimulation = 'off'; 
defaultIFNStimulationTime = 0; %hours
defaultEC50_RNAdeg = 5; %nM
defaultEC50_DetectorDeg = 0.001; %nM
defaultEC50_Protease = 20; %nM
defaultEC50_Translate = 10; %nM
defaultPlotResults = 'on';
defaultPlotType = 'semilog';
defaultSensitivityAnalysis = 'off'; 
defaultSensitivityAnalysisOutput = 'Plus RNA'; 
defaultScalingFactor = 10; 
defaultMaxScalingOrder = 2;
defaultExportData = 'off';
defaultDataFile = 'results.csv';
defaultRunCount = 100;
defaultUpperQuantile = 0.95;
defaultLowerQuantile = 0.05;
defaultCV = 0.05;

CVB3ODEEvalparser = inputParser;

%set general criteria for inputs
   validNum = @(x) isnumeric(x);
   validPosNum = @(x) isnumeric(x) && (x > 0);
   validPosNumOrZero = @(x) isnumeric(x) && (x >= 0);
   validSwitchString = @(x) strcmpi(x,'on') || strcmpi(x,'') || strcmpi(x,'off');
   validPopulationString = @(x) strcmpi(x,'Single Cell') || strcmpi(x,'Population');
   validSensString = @(x) strcmpi(x,'Plus RNA') || strcmpi(x,'Minus RNA') || strcmpi(x,'dsRNA') || strcmpi(x,'RNA Ratio') ||...
       strcmpi(x,'Polyprotein') || strcmpi(x,'Virion') || strcmpi(x,'Empty Provirion') || strcmpi(x,'Other') || strcmpi(x,'');
   validChar = @(x) ischar(x);
   validPercent = @(x) isnumeric(x) && (x > 0) && (x <= 1);
   validPlotType = @(x) strcmpi(x,'linear') || strcmpi(x,'semilog');
   
%set parser options and valid input criteria
   addRequired(CVB3ODEEvalparser,'MOI',validPosNumOrZero);
   
   addOptional(CVB3ODEEvalparser,'PopulationSetting',defaultPopulationSetting,validPopulationString);
   addOptional(CVB3ODEEvalparser,'MaxTime',defaultMaxTime,validPosNum);
   addOptional(CVB3ODEEvalparser,'IFNSwitch',defaultIFNSwitch,validSwitchString);
   addOptional(CVB3ODEEvalparser,'VirResponse',defaultVirResponse,validSwitchString);
   addOptional(CVB3ODEEvalparser,'IFNStimulation',defaultIFNStimulation,validSwitchString);
   addOptional(CVB3ODEEvalparser,'IFNStimulationTime',defaultIFNStimulationTime,validNum);
   addOptional(CVB3ODEEvalparser,'EC50_RNAdeg',defaultEC50_RNAdeg,validPosNumOrZero);
   addOptional(CVB3ODEEvalparser,'EC50_DetectorDeg',defaultEC50_DetectorDeg,validPosNumOrZero);
   addOptional(CVB3ODEEvalparser,'EC50_Protease',defaultEC50_Protease,validPosNumOrZero);
   addOptional(CVB3ODEEvalparser,'EC50_Translate',defaultEC50_Translate,validPosNumOrZero);
   addOptional(CVB3ODEEvalparser,'PlotResults',defaultPlotResults,validSwitchString);
   addOptional(CVB3ODEEvalparser,'PlotType',defaultPlotType,validPlotType);
   addOptional(CVB3ODEEvalparser,'SensitivityAnalysis',defaultSensitivityAnalysis,validSwitchString);
   addOptional(CVB3ODEEvalparser,'SensitivityAnalysisOutput',defaultSensitivityAnalysisOutput,validSensString);
   addOptional(CVB3ODEEvalparser,'ScalingFactor',defaultScalingFactor,validPosNum);
   addOptional(CVB3ODEEvalparser,'MaxScalingOrder',defaultMaxScalingOrder,validPosNum);
   addOptional(CVB3ODEEvalparser,'ExportData',defaultExportData,validSwitchString);
   addOptional(CVB3ODEEvalparser,'DataFile',defaultDataFile,validChar);
   addOptional(CVB3ODEEvalparser,'RunCount',defaultRunCount,validPosNum);
   addOptional(CVB3ODEEvalparser,'UpperQuantile',defaultUpperQuantile,validPercent);
   addOptional(CVB3ODEEvalparser,'LowerQuantile',defaultLowerQuantile,validPercent);
   addOptional(CVB3ODEEvalparser,'CV',defaultCV,validPosNumOrZero);

   parse(CVB3ODEEvalparser,MOI,varargin{:});

%Extract parsed inputs
MOI = CVB3ODEEvalparser.Results.MOI;
PopulationSetting = CVB3ODEEvalparser.Results.PopulationSetting;
MaxTime = CVB3ODEEvalparser.Results.MaxTime;
IFNSwitch = CVB3ODEEvalparser.Results.IFNSwitch;
VirResponse = CVB3ODEEvalparser.Results.VirResponse;
IFNStimulation = CVB3ODEEvalparser.Results.IFNStimulation;
IFNStimulationTime = CVB3ODEEvalparser.Results.IFNStimulationTime;
EC50_RNAdegi = CVB3ODEEvalparser.Results.EC50_RNAdeg;
EC50_DetectorDegi = CVB3ODEEvalparser.Results.EC50_DetectorDeg;
EC50_Proteasei = CVB3ODEEvalparser.Results.EC50_Protease;
EC50_Translatei = CVB3ODEEvalparser.Results.EC50_Translate;
PlotResults = CVB3ODEEvalparser.Results.PlotResults;
SensitivityAnalysis = CVB3ODEEvalparser.Results.SensitivityAnalysis;
SensitivityAnalysisOutput = CVB3ODEEvalparser.Results.SensitivityAnalysisOutput;
ScalingFactor = CVB3ODEEvalparser.Results.ScalingFactor;
MaxScalingOrder = CVB3ODEEvalparser.Results.MaxScalingOrder;
ExportData = CVB3ODEEvalparser.Results.ExportData;
DataFile = CVB3ODEEvalparser.Results.DataFile;

%If senstivity analysis is specified, override the RunCount to be 1 and the standard deviation to be 0.
%This ensures that we are only doing sensitivity analysis on the average parameter values.
if strcmpi(SensitivityAnalysis,'on')
   RunCount = 1;
   CV=0;
else
   RunCount = CVB3ODEEvalparser.Results.RunCount;
   CV = CVB3ODEEvalparser.Results.CV;
end

UpperQuantile = CVB3ODEEvalparser.Results.UpperQuantile;
LowerQuantile = CVB3ODEEvalparser.Results.LowerQuantile;
plotType=CVB3ODEEvalparser.Results.PlotType;

%% Process Inputs
%Prompt the user to enter additional information for custom sensitivity analysis    
if strcmpi(SensitivityAnalysisOutput,'Other')
    fprintf(['The options are: uCVB3, Defective uCVB3, uDAF, bDAF, Defective bDAF, uDAF TJ, bDAF TJ, Defective bDAF TJ, uCVB3 TJ, Defective uCVB3 TJ, uCAR, bCAR, Defective bCAR, R p endo, Defective R p endo,\nR p cyt, Defective R p cyt, T c, R n cyt, VRO Avail, R p VRO, R n VRO, Pol3D VRO, R Ip VRO, R In VRO, ATPase2C,\nPentamer cyt, Pentamer VRO, RNA-Bound Pentamer, P2Filled, P3Filled, P4Filled, P5Filled, P6Filled, P7Filled, P8Filled, P9Filled, P10Filled, P11Filled, Virion,\nP2Empty, P3Empty, P4Empty, P5Empty, P6Empty, P7Empty, P8Empty, P9Empty, P10Empty, P11Empty, Empty Provirion,\nViral Ribosomes, Host Ribosomes, Protease, ISG Protein\n'])
    OtherSpecies = input('Enter the name(s) of the species you wish to study as a vector of their names as strings separated by spaces.');   
else
    OtherSpecies = [];
end

%Ensure IFNStimulationTime is set to 0 if IFNStimulation is off 
if strcmpi(IFNStimulation,'off')||strcmpi(IFNStimulation,'')
    IFNStimulationTime = 0;
else
end

%Convert parameter means to mu and CV to sigma for use in log-normal random number generation for
%constants.

function mu = muFunc(M,V)
    mu = log((M^2)/sqrt(V+M^2));
end
sigma = sqrt(log(CV^2+1));

disp('Run Count: ') %Display the label of the Run Count progress tracker

%% Begin repeated simulations 
for i = 1:RunCount
%% Constants for the ODE (Justification for these constants can be found in the parameter table)
%Cell and virus non-rate constant parameters
CellVolume = 3700; %(um^3) 
NucVolume = 960; %(um^3) 
CellSurfaceArea = 2200; %(µm^2) 
CellCytVolume = CellVolume - NucVolume; %(um^3) 
CVB3diameter = 30; %(nm) 
Pol3DLength = 7.1; %(nm) 
MaxCVB3Conc = (6.022e23)^-1 / (4/3*pi*(CVB3diameter/2)^3) * 1e33; %(nM)
ParticlePFUConv = 800; %Number
VROSurfaceArea = 120; %(µm^2) 
VROSurfaceVolume = VROSurfaceArea * Pol3DLength/1000; %(µm^3) 
ISGbpLength = 1.75; %(kb)
k_transcribeISG = lognrnd(muFunc(170,(CV*170)^2),sigma); %(kb/h)
RiboActive = 0.8; %Fraction 
RiboTotal = 1e5; %Number
PolysomeSize = 2.5; %Average polysome size. 
TranslationRate = lognrnd(muFunc(3.5*3600,(CV*3.5*3600)^2),sigma); %(aa/h) 
PolymeraseRate = lognrnd(muFunc(50*3600,(CV*50*3600)^2),sigma); %(bp/h)  
CVB3genomelength = 7397; %(bp) 
CVB3polyprolength = 2185; %(aa) 
EncapsidatedNegStrandRatio = 1/1790; %Fraction

%Receptor binding constants
k_on_DAF = lognrnd(muFunc(1.47e5*3600/1e9,(CV*1.47e5*3600/1e9)^2),sigma); %(nM^-1 * h^-1) 
k_off_DAF = lognrnd(muFunc(0.3*3600,(CV*0.3*3600)^2),sigma); %(h^-1)
k_transloc = lognrnd(muFunc(60,(CV*60)^2),sigma); %(h^-1) 
k_on_CAR = lognrnd(muFunc(3.35e3*3600/1e9,(CV*3.35e3*3600/1e9)^2),sigma); %(nM^-1 * h^-1)
k_off_CAR = lognrnd(muFunc(8.21e-4*3600,(CV*8.21e-4*3600)^2),sigma); %(h^-1) 
k_internal = lognrnd(muFunc(0.5,(CV*0.5)^2),sigma); %(h^-1) 
k_endo_escape = lognrnd(muFunc(420,(CV*420)^2),sigma); %(h^-1)  
InternalVolConv = CellSurfaceArea / (6.022e23 * CVB3diameter^2 * MaxCVB3Conc * CellCytVolume) * 1e30; %(dimensionless)

%Replication constants 
VROFormThreshold = 25; %(molecules)
k_T_c_Form = lognrnd(muFunc(25/PolysomeSize,(CV*25/PolysomeSize)^2),sigma); %(h^-1 * nM^-1)
k_Translate = TranslationRate * PolysomeSize / CVB3polyprolength; %(h^-1) 
k_P_on = lognrnd(muFunc(1,(CV*1)^2),sigma); %(h^-1) 
k_P_off = lognrnd(muFunc(1,(CV*1)^2),sigma); %(h^-1) 
k_N_on = lognrnd(muFunc(1,(CV*1)^2),sigma); %(h^-1) 
k_N_off = lognrnd(muFunc(1,(CV*1)^2),sigma); %(h^-1) 
VROVolConv = CellCytVolume/VROSurfaceVolume; %(dimensionless)
k_R_Ip_Form = lognrnd(muFunc(0.36,(CV*0.36)^2),sigma); %(nM^-1 h^-1) 
k_N_Transcript = PolymeraseRate / CVB3genomelength; %(h^-1) 
k_P_Transcript = PolymeraseRate / CVB3genomelength; %(h^-1) 
k_R_In_Form = lognrnd(muFunc(0.36,(CV*0.36)^2),sigma); %(nM^-1 h^-1) 
u_P_cyt = lognrnd(muFunc(3.5,(CV*0.23)^2),sigma); %(h^-1) 
u_P_VRO = lognrnd(muFunc(0.23/VROVolConv,(CV*0.23/VROVolConv)^2),sigma); %(h^-1) 
u_N_cyt = lognrnd(muFunc(0.23,(CV*0.23)^2),sigma); %(h^-1) 
u_N_VRO = lognrnd(muFunc(0.23/VROVolConv,(CV*0.23/VROVolConv)^2),sigma); %(h^-1) 
u_T_c = 0; %(h^-1) 
u_VirProt_cyt = lognrnd(muFunc(0.05,(CV*0.05)^2),sigma); %(h^-1)
u_VirProt_VRO = lognrnd(muFunc(0.05/VROVolConv,(CV*0.05/VROVolConv)^2),sigma); %(h^-1) 

%Capsid assembly constants:
k1f_cap = lognrnd(muFunc(3.6,(CV*3.6)^2),sigma); %(nM^-1 h^-1) 
k1b_cap = lognrnd(muFunc(3.6e3,(CV*3.6e3)^2),sigma); %(h^-1) 
k_Pentamer_on = lognrnd(muFunc(0.36,(CV*0.36)^2),sigma); %(nM^-1 h^-1)
k_Pentamer_off = lognrnd(muFunc(36,(CV*36)^2),sigma); %(h^-1) 
kRNACapBind = lognrnd(muFunc(3.6,(CV*3.6)^2),sigma); %(nM^-1 h^-1)
kRNACapUnbind = lognrnd(muFunc(3.6e3,(CV*3.6e3)^2),sigma); %(h^-1) 
k2f_cap = lognrnd(muFunc(3.6,(CV*3.6)^2),sigma); %(nM^-1 h^-1) 
k2b_cap = lognrnd(muFunc(3.6e3,(CV*3.6e3)^2),sigma); %(h^-1) 
u_cap_cyt = lognrnd(muFunc(0.05,(CV*0.05)^2),sigma); %(h^-1) 
u_cap_VRO = lognrnd(muFunc(0.05/VROVolConv,(CV*0.05/VROVolConv)^2),sigma); %(h^-1) 

%Feedback loop constants
kcat_cleave = lognrnd(muFunc(0.3216*3600,(CV*0.3216*3600)^2),sigma); %(h^-1)
Km_cleave = lognrnd(muFunc(960e3,(CV*960e3)^2),sigma); %(nM)
InitRibAvail = (1 - RiboActive) * RiboTotal / PolysomeSize / (6.022e23 * CellCytVolume) * 1e24; %(nM)
kD_Hill = lognrnd(muFunc(1,(CV*1)^2),sigma); %(nM)
n_Hill = lognrnd(muFunc(1.36,(CV*1.36)^2),sigma); %(dimensionless)
ISGformRate = k_transcribeISG/ISGbpLength; %(h^-1)
StimISG = 0; %(dimensionless)
ISGBasal = 0; %(nM) 
u_ISG = lognrnd(muFunc(0.1,(CV*0.1)^2),sigma); %(h^-1)
EC50_Protease = lognrnd(muFunc(EC50_Proteasei,(CV*EC50_Proteasei)^2),sigma); %(nM)
EC50_Translate = lognrnd(muFunc(EC50_Translatei,(CV*EC50_Translatei)^2),sigma); %(nM)
OAS_RNAdeg = lognrnd(muFunc(5,(CV*5)^2),sigma); %(nM)
EC50_RNAdeg = lognrnd(muFunc(EC50_RNAdegi,(CV*EC50_RNAdegi)^2),sigma); %(nM)
EC50_DetectorDeg = lognrnd(muFunc(EC50_DetectorDegi,(CV*EC50_DetectorDegi)^2),sigma); %(nM)

%Creates vector of all constants needed for rate equations. 
Constants = [k_on_DAF,k_off_DAF,k_transloc,k_on_CAR,k_off_CAR,k_internal,InternalVolConv,k_endo_escape ...
            PolysomeSize,k_T_c_Form,k_Translate,k_P_on,k_P_off,k_N_on,k_N_off,VROVolConv,k_R_Ip_Form,k_N_Transcript,k_P_Transcript,k_R_In_Form ...
            u_P_cyt,u_P_VRO,u_N_cyt,u_N_VRO,u_T_c,u_VirProt_cyt,u_VirProt_VRO ...
            k1f_cap,k2f_cap,k1b_cap,k2b_cap,kRNACapBind,kRNACapUnbind,k_Pentamer_on,k_Pentamer_off,u_cap_cyt,u_cap_VRO ...
            kcat_cleave,Km_cleave,InitRibAvail,u_ISG,ISGformRate,StimISG,ISGBasal,kD_Hill,n_Hill,EC50_Protease,EC50_Translate,OAS_RNAdeg,EC50_RNAdeg,EC50_DetectorDeg,VROFormThreshold];
 
%Creates vector of labels for the above constants.      
ConstantLabels = {'k_on_DAF' 'k_off_DAF' 'k_transloc' 'k_on_CAR' 'k_off_CAR' 'k_internal' 'Cyt_Vol._Conv.'  'k_endo_escape'  ...
    'PolysomeSize' 'k_Tc_Form' 'k_Translate' 'k_P_on' 'k_P_off' 'k_N_on' 'k_N_off' 'VRO_Vol._Conv.' 'k_RIp_Form' 'k_N_Transcribe' 'k_P_Transcribe' 'k_RIn_Form'  ...
    'u_P_cyt' 'u_P_VRO' 'u_N_cyt' 'u_N_VRO' 'u_T_c' 'u_VirProt_cyt' 'u_VirProt_VRO' ...
    'k1f_cap' 'k2f_cap' 'k1b_cap' 'k2b_cap' 'k_RNACapBind' 'k_RNACapUnbind' 'k_Pentamer_on' 'k_Pentamer_off' 'u_cap_cyt' 'u_cap_VRO' ...
    'kcat_cleave' 'Km_cleave' 'Initial_Viral_Ribosomes' 'u_ISG' 'ISGformRate' 'StimISG' 'ISGBasal' 'kD_Hill' 'Hill_Constant' 'EC50_Protease' 'EC50_Translate' 'OAS_RNAdeg' 'EC50_RNAdeg' 'EC50_DetectorDeg' 'VRO_Formation_Threshold'};

%Creates a labeled table of constants
LabeledConstants = table(Constants','RowNames',ConstantLabels,'VariableNames',{'Value'});

%% Initial conditions for the ODE

%Viral Particles
if strcmpi(PopulationSetting,'Population') %Population mode
    uCVB3 = poissrnd(MOI) * (CVB3diameter/1000)^2 / CellSurfaceArea * MaxCVB3Conc; %(nM) Unbound infectious CVB3 virions at cell surface
else %Defaults to single-cell Mode
    uCVB3 = MOI * (CVB3diameter/1000)^2 / CellSurfaceArea * MaxCVB3Conc; %(nM) Unbound infectious CVB3 virions at cell surface
end
uCVB3_Defective = ParticlePFUConv * uCVB3; %(nM) Unbound defective CVB3 virions at cell surface

%Receptors and Internalization
uDAF = 4.4e4 / (6.022e23) / (CVB3diameter/1000 * CellSurfaceArea) * 1e24; %(nM) Unbound DAF molecules
bDAF = 0; %(nM) CVB3-bound DAF molecules
bDAF_Defective = 0; %(nM) Defective CVB3-Bound DAF not in tight junctions
uDAF_TJ = 0; %(nM) Unbound DAF in tight junctions
bDAF_TJ = 0; %(nM) CVB3-Bound DAF in tight junctions
bDAF_Defective_TJ = 0; %(nM) Defective CVB3-Bound DAF in tight junctions
uCVB3_TJ = 0; %(nM) Unbound CVB3 in tight junctions
uCVB3_Defective_TJ = 0; %(nM) Unbound defective CVB3 virions in tight junctions
uCAR = 5.5e6 / (6.022e23) / (CVB3diameter/1000 * CellSurfaceArea) * 1e24; %(nM) Unbound CAR in tight junctions
bCAR = 0; %(nM) CVB3-Bound CAR in tight junctions
bCAR_Defective = 0; %(nM) Defective CVB3-Bound CAR in tight junctions
R_p_endo = 0; %(nM) Internalized virus that has not yet been unpackaged
R_p_endo_Defective = 0; %(nM) Interalized defective virus that has not yet been unpackaged

%Replication
R_p_cyt = 0; %(nM) Positive-strand RNA in the cytoplasm
R_p_cyt_Defective = 0; %(nM) Defective positive-strand RNA in the cytoplasm
T_c = 0; %(nM) Translation complexes (Positive strand + Ribosome) in the cytoplasm
R_n_cyt = 0; %(nM) Negative-strand RNA in the cytoplasm
R_p_VRO = 0; %(nM) Positive-strand RNA on the VRO
R_n_VRO = 0; %(nM) Negative-strand RNA on the VRO
Pol3D_VRO = 0; %(nM) Polymerases and associated proteins needed for transcription on the VRO
R_Ip_VRO = 0; %(nM) Positive-strand RNA transcription complexes (Positive strand + Polymerase) on the VRO
R_In_VRO = 0; %(nM) Negative-strand RNA transcription complexes (Negative strand + Polymerase) on the VRO
ATPase2C = 0; %(nM) 2C ATPase molecules on the VRO used for capsid pentamer interaction

%Capsid Assembly
Pentamer_cyt = 0; %(nM) 5 protomers (20 VPs) assembled into much more stable pentamer form in the cytoplasm
Pentamer_VRO = 0; %(nM) 5 protomers (20 VPs) assembled into much more stable pentamer form on the VRO
RNAPentamer = 0; %(nM) Pentamer in cytoplasm that has bound a positive RNA strand
Virion = 0; %(nM) Mature, infectious virions in the cytoplasm
EmptyProvirion = 0; %(nM) Self-assembled 12-pentamer capsid molecules that lack +ssRNA in the cytoplasm
P2Filled = 0; P2Empty = 0; P3Filled = 0; P3Empty = 0; P4Filled = 0; P4Empty = 0; P5Filled = 0; P5Empty = 0; P6Filled = 0; P6Empty = 0; %(nM) Partially assembled capsid stages
P7Filled = 0; P7Empty = 0; P8Filled = 0; P8Empty = 0; P9Filled = 0; P9Empty = 0; P10Filled = 0; P10Empty = 0; P11Filled = 0; P11Empty = 0; %(nM) Partially assembled capsid stages

RibAvail = InitRibAvail; %(nM) Polysome complexes (of 2-3 ribosomes each) initially inactive and accessible to the virus
RibUnavail = RiboActive * RiboTotal / PolysomeSize / (6.022e23 * CellCytVolume) * 1e24; %(nM) Polysome complexes (of 2-3 ribosomes each) initially in-use by host and inaccessible to the virus
Protease = 0; %(nM) Viral proteases in the cytoplasm
ISGProtein = ISGBasal; %(nM) ISG protein in the cytoplasm

%Set the initial ISGProtein concentration in the event of pre-stimulation
if IFNStimulationTime < 0
    StimISG = 1; %Starts Interferon response at the start of the simulation.
    
    %Runs the ODE to calculate ISG levels. Note: Viral proteases do not need to be accounted for since we're running this simulation before infection begins.
    [~,PrimedISGProtein] = ode15s(@(t,PrimedISGProtein) StimISG * ISGformRate * RibUnavail - u_ISG * PrimedISGProtein,[0 abs(IFNStimulationTime)],ISGProtein,odeset('NonNegative',1));
    
    ISGProtein = ISGProtein + PrimedISGProtein(length(PrimedISGProtein)); %Sets the initial value of ISGProtein to the final value (and adds back in basal levels)
end   

%Create initial values vector for ODE solver.
InitVals = [uCVB3,uCVB3_Defective,uDAF,bDAF,bDAF_Defective,uDAF_TJ,bDAF_TJ,bDAF_Defective_TJ,uCVB3_TJ,uCVB3_Defective_TJ,uCAR,bCAR,bCAR_Defective,R_p_endo,R_p_endo_Defective ...
 R_p_cyt,R_p_cyt_Defective,T_c,R_n_cyt,R_p_VRO,R_n_VRO,Pol3D_VRO,R_Ip_VRO,R_In_VRO,ATPase2C ...
 Pentamer_cyt,Pentamer_VRO,RNAPentamer,P2Filled,P3Filled,P4Filled,P5Filled,P6Filled,P7Filled,P8Filled,P9Filled,P10Filled,P11Filled,Virion ...
 P2Empty,P3Empty,P4Empty,P5Empty,P6Empty,P7Empty,P8Empty,P9Empty,P10Empty,P11Empty,EmptyProvirion ...
 RibAvail,RibUnavail,Protease,ISGProtein];

%Create labels vector for the above initial values.
InitValLabels = {'uCVB3' 'Defective uCVB3' 'uDAF' 'bDAF' 'Defective bDAF' 'uDAF TJ' 'bDAF TJ' 'Defective bDAF TJ' 'uCVB3 TJ' 'Defective uCVB3 TJ' 'uCAR' 'bCAR' 'Defective bCAR' 'R p endo' 'Defective R p endo' ...
    'R p cyt' 'Defective R p cyt' 'T c' 'R n cyt' 'R p VRO' 'R n VRO' 'Pol3D VRO' 'R Ip VRO' 'R In VRO' 'ATPase2C' ...
    'Pentamer cyt' 'Pentamer VRO' 'RNA-Bound Pentamer' 'P2Filled' 'P3Filled' 'P4Filled' 'P5Filled' 'P6Filled' 'P7Filled' 'P8Filled' 'P9Filled' 'P10Filled' 'P11Filled' 'Virion' ... 
    'P2Empty' 'P3Empty' 'P4Empty' 'P5Empty' 'P6Empty' 'P7Empty' 'P8Empty' 'P9Empty' 'P10Empty' 'P11Empty' 'Empty Provirion' ...
    'Viral Ribosomes' 'Host Ribosomes' 'Protease' 'ISG Protein'};

%Create a labeled table of initial conditions
LabeledInitVals = table(InitVals','RowNames',InitValLabels,'VariableNames',{'Value'});

%% Runs the ODE and Sensitivity analysis and Assigns Outputs

%Additional ODE solver inputs and options
TSPAN = linspace(0,MaxTime,60*MaxTime);  %Range of hours for the simulation
Options = odeset('RelTol',10e-6,'AbsTol',10e-6,'NonNegative',1:length(InitVals));

[t,SolutionsMatrix] = ode15s(@(t,y)CVB3ODEfunc(t,y,Constants,IFNSwitch,VirResponse,IFNStimulation,IFNStimulationTime),TSPAN,InitVals,Options); %Solving the ODE

%Store all results
SolutionsTensor(:,:,i) = SolutionsMatrix(:,:);

%Runs sensitivity analysis if toggled on
if strcmpi(SensitivityAnalysis,'on')
    [SensTable]= SensitivityAnalysisfunc(@CVB3ODEfunc,LabeledConstants,LabeledInitVals,SensitivityAnalysisOutput,OtherSpecies,ScalingFactor,MaxScalingOrder,IFNSwitch,VirResponse,IFNStimulation,IFNStimulationTime,MaxTime,Options);
end

fprintf('%2d ',i) %Display current run count

end

%% Prepares Solutions for export and plotting if desired

%Convert VRO localized concentrations back to cytoplasmic concentrations when VROs are present
for k = 1:size(SolutionsTensor,3)
    i = 1; j = size(SolutionsTensor,1);
    while i < j && SolutionsTensor(i,22,k) < VROFormThreshold * 6e-4 %Pol3D_VRO; 6e-4 is concentration of 1 molecule in nM
        i = i + 1;
    end
    if i ~= j
        SolutionsTensor(i:j,20:50,k) = SolutionsTensor(i:j,20:50,k)./VROVolConv; %Scale VRO-resident species
    end
end

%Permute SolutionsTensor for summary species
PermuteSolutionsTensor = permute(SolutionsTensor,[1,3,2]);

%Total VP1- Note: Surface-bound species not counted because experimentally cells are washed before lysis
TotalP1 = 0*InternalVolConv*60*(sum(PermuteSolutionsTensor(:,:,4:5),3) ... %bDAF, bDAF_Defective
    + sum(PermuteSolutionsTensor(:,:,7:8),3) ... %bDAF_TJ, bDAF_Defective_TJ
    + sum(PermuteSolutionsTensor(:,:,12:13),3)) ... %bCAR, bCAR_Defective
    + 60*sum(PermuteSolutionsTensor(:,:,14:15),3) ...  %R_p_endo, R_p_endo_Defective
    + 5*(sum(PermuteSolutionsTensor(:,:,26:28),3) ...  %Pentamer_cyt, Pentamer_VRO, RNAPentamer
    + 2*sum(PermuteSolutionsTensor(:,:,[29 40]),3) ...  %P2Filled, P2Empty
    + 3*sum(PermuteSolutionsTensor(:,:,[30 41]),3) ...  %P3Filled, P3Empty
    + 4*sum(PermuteSolutionsTensor(:,:,[31 42]),3) ...  %P4Filled, P4Empty
    + 5*sum(PermuteSolutionsTensor(:,:,[32 43]),3) ...  %P5Filled, P5Empty
    + 6*sum(PermuteSolutionsTensor(:,:,[33 44]),3) ...  %P6Filled, P6Empty
    + 7*sum(PermuteSolutionsTensor(:,:,[34 45]),3) ...  %P7Filled, P7Empty
    + 8*sum(PermuteSolutionsTensor(:,:,[35 46]),3) ...  %P8Filled, P8Empty
    + 9*sum(PermuteSolutionsTensor(:,:,[36 47]),3) ...  %P9Filled, P9Empty
    + 10*sum(PermuteSolutionsTensor(:,:,[37 48]),3) ... %P10Filled, P10Empty
    + 11*sum(PermuteSolutionsTensor(:,:,[38 49]),3) ... %P11Filled, P11Empty
    + 12*sum(PermuteSolutionsTensor(:,:,[39 50]),3));   %Virion, EmptyProvirion

%Total viral RdRp 3D polymerase
TotalP2 = sum(PermuteSolutionsTensor(:,:,22:24),3); %Pol3D_VRO, R_Ip_VRO, R_In_VRO;

%Total viral protease
TotalP3 = PermuteSolutionsTensor(:,:,53); %Protease

%Total VRO associated viral proteins
TotalP4 = sum(PermuteSolutionsTensor(:,:,[25 27]),3) ... %ATPase2C, Pentamer_VRO
    + sum(PermuteSolutionsTensor(:,:,40:50),3); %Empty pentamer species; filled pentamers are bound by RNA, not ATPase2C
    
%Creates summary species
TotalPosStrands = InternalVolConv*(0*sum(PermuteSolutionsTensor(:,:,4:5),3) ... %bDAF, bDAF_Defective; assumed instantly removed before lysis
    + 0*sum(PermuteSolutionsTensor(:,:,7:8),3) ... %bDAF_TJ, bDAF_Defective_TJ; assumed instantly removed before lysis
    + sum(PermuteSolutionsTensor(:,:,12:13),3)) ... %bCAR, bCAR_Defective
    + sum(PermuteSolutionsTensor(:,:,14:15),3) ...  %R_p_endo, R_p_endo_Defective
    + sum(PermuteSolutionsTensor(:,:,16:18),3) ...  %R_p_cyt, R_p_cyt_Defective, T_c
    + PermuteSolutionsTensor(:,:,20) ...  %R_p_VRO
    + 0*PermuteSolutionsTensor(:,:,23) ... %R_Ip_VRO
    + sum(PermuteSolutionsTensor(:,:,28:39),3); %RNAPentamer and filled pentamer species
TotalNegStrands = EncapsidatedNegStrandRatio*(InternalVolConv*(0*sum(PermuteSolutionsTensor(:,:,4:5),3) ... %bDAF, bDAF_Defective; assumed instantly removed before lysis
    + 0*sum(PermuteSolutionsTensor(:,:,7:8),3) ... %bDAF_TJ, bDAF_Defective_TJ; assumed instantly removed before lysis
    + sum(PermuteSolutionsTensor(:,:,12:13),3)) ... %bCAR, bCAR_Defective
    + sum(PermuteSolutionsTensor(:,:,14:15),3) ... %R_p_endo, R_p_endo_Defective
    + sum(PermuteSolutionsTensor(:,:,17),3)) ... %R_p_cyt_Defective
    + PermuteSolutionsTensor(:,:,19) ... %R_n_cyt
    + PermuteSolutionsTensor(:,:,21) ... %R_n_VRO
    + 0*PermuteSolutionsTensor(:,:,24); %R_In_VRO
TotalRNARatio = TotalPosStrands./TotalNegStrands;
TotalDoubleStrands = sum(PermuteSolutionsTensor(:,:,23:24),3); %R_Ip_VRO, R_In_VRO;
TotalDoubleStrandsVRO = TotalDoubleStrands.*VROVolConv;

%Convert the time array to a step function corresponding to the stimulation time.
if IFNStimulationTime<0 
    stimulationStepFunction = ones(length(t),1); %If pre-stimulation occurs, exogenous IFN is always on.
else
    stimulationStepFunction = floor(t-IFNStimulationTime)>= 0; %If stimulation occurs sometime after simulation start, only after that time is exogenous IFN on.
end

%Find the inverse of the stimulationStepFunction. This will be the scaling function for endogenous VirDetection. The contribution of VirDetection to IFN response is superseded by exogenous stimulation. 
virDetectionScalingFunction = 1-stimulationStepFunction;

%Create host-virus interaction species for later plotting
if strcmpi(IFNSwitch,'on') && (strcmpi(IFNStimulation,'on') == 0) %If endogenous response is active but there is no exogenous IFN stimulation
    
    VirDetection = ((TotalDoubleStrandsVRO).^n_Hill)./(kD_Hill^n_Hill + (TotalDoubleStrandsVRO).^n_Hill); %Viral detection proceeds throughout the simulation
    StimISG = zeros(length(t),size(PermuteSolutionsTensor,2)); %No exogenous stimulation contributes to the IFNResponse.
    
elseif strcmpi(IFNStimulation,'on') && strcmpi(IFNSwitch,'on') %If endogenous response is active and the cell is exogenously stimulated
    
    VirDetection = virDetectionScalingFunction .* ((TotalDoubleStrandsVRO).^n_Hill)./(kD_Hill^n_Hill + (TotalDoubleStrandsVRO).^n_Hill); %Viral detection proceeds until exogenous stimulation when the response becomes saturated 
    StimISG = stimulationStepFunction .* ones(length(t),size(PermuteSolutionsTensor,2)); %Exogenous stimulation saturates the response at the time of stimulation.
    
elseif strcmpi(IFNSwitch,'on') == 0 %If interferon response is off
    
    VirDetection = zeros(length(t),size(PermuteSolutionsTensor,2)); %No viral detection occurs in this situation
    StimISG = zeros(length(t),size(PermuteSolutionsTensor,2)); %No exogenous stimulation occurs.
    
end

if strcmpi(VirResponse,'on')
    VirDetection = VirDetection.*(1 - TotalP3./(TotalP3 + EC50_DetectorDeg)); %Scales down viral detection for IFN response if the virus's response to the IFN response is active.
end

%According to the endogenous viral detection and exogenous IFN stimulation calculate the total interferon response.
IFNResponse = VirDetection + StimISG;

%Determine the medians of the model species solutions
MediansMatrix = median(SolutionsTensor,3);
IFNResponseSummary(:,1) = median(IFNResponse,2);
TotalPosStrandsSummary(:,1) = median(TotalPosStrands,2);
TotalNegStrandsSummary(:,1) = median(TotalNegStrands,2);
TotalDoubleStrandsSummary(:,1) = median(TotalDoubleStrands,2);
TotalP1Summary(:,1) = median(TotalP1,2);

%Determine the quartiles of the model species solutions
UpperQuantileMatrix = quantile(SolutionsTensor,UpperQuantile,3);
IFNResponseSummary(:,2) = quantile(IFNResponse,UpperQuantile,2);
TotalPosStrandsSummary(:,2) = quantile(TotalPosStrands,UpperQuantile,2);
TotalNegStrandsSummary(:,2) = quantile(TotalNegStrands,UpperQuantile,2);
TotalDoubleStrandsSummary(:,2) = quantile(TotalDoubleStrands,UpperQuantile,2);
TotalP1Summary(:,2) = quantile(TotalP1,UpperQuantile,2);

LowerQuantileMatrix = quantile(SolutionsTensor,LowerQuantile,3);
IFNResponseSummary(:,3) = quantile(IFNResponse,LowerQuantile,2);
TotalPosStrandsSummary(:,3) = quantile(TotalPosStrands,LowerQuantile,2);
TotalNegStrandsSummary(:,3) = quantile(TotalNegStrands,LowerQuantile,2);
TotalDoubleStrandsSummary(:,3) = quantile(TotalDoubleStrands,LowerQuantile,2);
TotalP1Summary(:,3) = quantile(TotalP1,LowerQuantile,2);

%Determine the means of the model species solutions
MeansMatrix = mean(SolutionsTensor,3);
IFNResponseSummary(:,4) = mean(IFNResponse,2);
TotalPosStrandsSummary(:,4) = mean(TotalPosStrands,2);
TotalNegStrandsSummary(:,4) = mean(TotalNegStrands,2);
TotalDoubleStrandsSummary(:,4) = mean(TotalDoubleStrands,2);
TotalP1Summary(:,4) = mean(TotalP1,2);

%Create new solutions tensor
SummarySolutionsTensor(:,:,1) = MediansMatrix;
SummarySolutionsTensor(:,:,2) = UpperQuantileMatrix;
SummarySolutionsTensor(:,:,3) = LowerQuantileMatrix;
SummarySolutionsTensor(:,:,4) = MeansMatrix;

%Rearrange tensor
dimensions = size(SummarySolutionsTensor);
FinalSolutionsTensor = permute(SummarySolutionsTensor,[1,3,2]);

%Assign Solutions matrices
FinalSolutionsCell = mat2cell(FinalSolutionsTensor,dimensions(1),dimensions(3),ones([1,dimensions(2)]));
[uCVB3,uCVB3_Defective,uDAF,bDAF,bDAF_Defective,uDAF_TJ,bDAF_TJ,bDAF_Defective_TJ,uCVB3_TJ,uCVB3_Defective_TJ,uCAR,bCAR,bCAR_Defective,R_p_endo,R_p_endo_Defective, ...
 R_p_cyt,R_p_cyt_Defective,T_c,R_n_cyt,R_p_VRO,R_n_VRO,Pol3D_VRO,R_Ip_VRO,R_In_VRO,ATPase2C, ...
 Pentamer_cyt,Pentamer_VRO,RNAPentamer,P2Filled,P3Filled,P4Filled,P5Filled,P6Filled,P7Filled,P8Filled,P9Filled,P10Filled,P11Filled,Virion, ...
 P2Empty,P3Empty,P4Empty,P5Empty,P6Empty,P7Empty,P8Empty,P9Empty,P10Empty,P11Empty,EmptyProvirion, ...
 RibAvail,RibUnavail,Protease,ISGProtein] = FinalSolutionsCell{:};

%Get the parsed run parameters to output
if strcmpi(SensitivityAnalysis,'on')
    RunParameters = {sprintf('MOI: %d', MOI)...
        sprintf('MaxTime (h): %d', MaxTime)...
        strcat('IFNSwitch: ',IFNSwitch)...
        strcat('VirResponse: ',VirResponse)...
        strcat('IFNStimulation: ',IFNStimulation)...
        sprintf('IFNStimulationTime (h): %d', IFNStimulationTime)...
        strcat('SensitivityAnalysis: ',SensitivityAnalysis)...
        strcat('SensitivityAnalysisOutput: ' ,SensitivityAnalysisOutput)...
        sprintf('ScalingFactor: %d', ScalingFactor)...
        sprintf('MaxScalingOrder: %d',MaxScalingOrder)...
        strcat('ExportData: ',ExportData)...
        strcat('DataFile: ',DataFile)...
        sprintf('RunCount: %d',RunCount)...
        sprintf('UpperQuantile: %d',UpperQuantile)...
        sprintf('LowerQuantile: %d',LowerQuantile)...
        sprintf('CV: %d',CV)};
else
    RunParameters = {sprintf('MOI: %d', MOI)...
        sprintf('MaxTime (h): %d', MaxTime)...
        strcat('IFNSwitch: ',IFNSwitch)...
        strcat('VirResponse: ',VirResponse)...
        strcat('IFNStimulation: ',IFNStimulation)...
        sprintf('IFNStimulationTime (h): %d', IFNStimulationTime)...
        strcat('SensitivityAnalysis: ',SensitivityAnalysis)...
        strcat('ExportData: ',ExportData)...
        strcat('DataFile: ',DataFile)...
        sprintf('RunCount: %d',RunCount)...
        sprintf('UpperQuantile: %d',UpperQuantile)...
        sprintf('LowerQuantile: %d',LowerQuantile)...
        sprintf('CV: %d',CV)};
end

ResultsLabels = {'Time'...
    'Unbound CVB3' 'Defective Unbound CVB3' 'Unbound DAF' 'CVB3-DAF' 'Defective CVB3-DAF' 'Unbound DAF in TJ' 'CVB3-DAF in TJ' 'Defective CVB3-DAF in TJ' 'Unbound CVB3 in TJ' 'Defective Unbound CVB3 in TJ' 'Unbound CAR' 'Bound CAR' 'Defective Bound CAR','Endosomal +ssRNA' 'Defective Endosomal +ssRNA'...
    'Cytoplasmic +ssRNA' 'Defective Cytoplasmic +ssRNA' 'Cytoplasmic -ssRNA' 'Translation Complex' 'Viral Ribosomes' 'Host Ribosomes' 'Protease' 'Cytoplasmic Pentamer'...
    'VRO +ssRNA' 'VRO -ssRNA' 'VRO +ssRNA Replication Complex' 'VRO -ssRNA Replication Complex' 'VRO Viral Polymerase 3D' 'VRO Viral 2C' 'VRO Pentamer'...
    'RNA-Bound Pentamer' '+ssRNA-2xPentamer' '+ssRNA-3xPentamer' '+ssRNA-4xPentamer' '+ssRNA-5xPentamer' '+ssRNA-6xPentamer' '+ssRNA-7xPentamer' '+ssRNA-8xPentamer' '+ssRNA-9xPentamer' '+ssRNA-10xPentamer' '+ssRNA-11xPentamer' 'Virions'...
    '2xPentamer' '3xPentamer' '4xPentamer' '5xPentamer' '6xPentamer' '7xPentamer' '8xPentamer' '9xPentamer' '10xPentamer' '11xPentamer' 'Empty Provirions'...
    'IFN Response' 'Interferon Stimulated Proteins'... 
    'Total +ssRNA' 'Total -ssRNA' 'Total dsRNA' 'Total Viral Protein'};

MedianTable = table(t,...%Time
    uCVB3(:,1),uCVB3_Defective(:,1),uDAF(:,1),bDAF(:,1),bDAF_Defective(:,1),uDAF_TJ(:,1),bDAF_TJ(:,1),bDAF_Defective_TJ(:,1),uCVB3_TJ(:,1),uCVB3_Defective_TJ(:,1),uCAR(:,1),bCAR(:,1),bCAR_Defective(:,1),R_p_endo(:,1),R_p_endo_Defective(:,1),...%Delivery
    R_p_cyt(:,1),R_p_cyt_Defective(:,1),R_n_cyt(:,1),T_c(:,1),RibAvail(:,1),RibUnavail(:,1),Protease(:,1),Pentamer_cyt(:,1),...%Translation and cytoplasmic species
    R_p_VRO(:,1),R_n_VRO(:,1),R_Ip_VRO(:,1),R_In_VRO(:,1),Pol3D_VRO(:,1),ATPase2C(:,1),Pentamer_VRO(:,1),...%Viral Replication Organelle 
    RNAPentamer(:,1),P2Filled(:,1),P3Filled(:,1),P4Filled(:,1),P5Filled(:,1),P6Filled(:,1),P7Filled(:,1),P8Filled(:,1),P9Filled(:,1),P10Filled(:,1),P11Filled(:,1),Virion(:,1),...%Virion Assembly
    P2Empty(:,1),P3Empty(:,1),P4Empty(:,1),P5Empty(:,1),P6Empty(:,1),P7Empty(:,1),P8Empty(:,1),P9Empty(:,1),P10Empty(:,1),P11Empty(:,1),EmptyProvirion(:,1),...
    IFNResponseSummary(:,1),ISGProtein(:,1),...%Host-virus Interaction
    TotalPosStrandsSummary(:,1), TotalNegStrandsSummary(:,1), TotalDoubleStrandsSummary(:,1), TotalP1Summary(:,1),...%Summary species
    'VariableNames',ResultsLabels);

UpperQuantileTable = table(t,...%Time
    uCVB3(:,2),uCVB3_Defective(:,2),uDAF(:,2),bDAF(:,2),bDAF_Defective(:,2),uDAF_TJ(:,2),bDAF_TJ(:,2),bDAF_Defective_TJ(:,2),uCVB3_TJ(:,2),uCVB3_Defective_TJ(:,2),uCAR(:,2),bCAR(:,2),bCAR_Defective(:,2),R_p_endo(:,2),R_p_endo_Defective(:,2),...%Delivery
    R_p_cyt(:,2),R_p_cyt_Defective(:,2),R_n_cyt(:,2),T_c(:,2),RibAvail(:,2),RibUnavail(:,2),Protease(:,2),Pentamer_cyt(:,2),...%Translation and cytoplasmic species
    R_p_VRO(:,2),R_n_VRO(:,2),R_Ip_VRO(:,2),R_In_VRO(:,2),Pol3D_VRO(:,2),ATPase2C(:,2),Pentamer_VRO(:,2),...%Viral Replication Organelle 
    RNAPentamer(:,2),P2Filled(:,2),P3Filled(:,2),P4Filled(:,2),P5Filled(:,2),P6Filled(:,2),P7Filled(:,2),P8Filled(:,2),P9Filled(:,2),P10Filled(:,2),P11Filled(:,2),Virion(:,2),...%Virion Assembly
    P2Empty(:,2),P3Empty(:,2),P4Empty(:,2),P5Empty(:,2),P6Empty(:,2),P7Empty(:,2),P8Empty(:,2),P9Empty(:,2),P10Empty(:,2),P11Empty(:,2),EmptyProvirion(:,2),...
    IFNResponseSummary(:,2),ISGProtein(:,2),...%Host-virus Interaction
    TotalPosStrandsSummary(:,2), TotalNegStrandsSummary(:,2), TotalDoubleStrandsSummary(:,2), TotalP1Summary(:,2),...%Summary species
    'VariableNames',ResultsLabels);

LowerQuantileTable = table(t,...%Time
    uCVB3(:,3),uCVB3_Defective(:,3),uDAF(:,3),bDAF(:,3),bDAF_Defective(:,3),uDAF_TJ(:,3),bDAF_TJ(:,3),bDAF_Defective_TJ(:,3),uCVB3_TJ(:,3),uCVB3_Defective_TJ(:,3),uCAR(:,3),bCAR(:,3),bCAR_Defective(:,3),R_p_endo(:,3),R_p_endo_Defective(:,3),...%Delivery
    R_p_cyt(:,3),R_p_cyt_Defective(:,3),R_n_cyt(:,3),T_c(:,3),RibAvail(:,3),RibUnavail(:,3),Protease(:,3),Pentamer_cyt(:,3),...%Translation and cytoplasmic species
    R_p_VRO(:,3),R_n_VRO(:,3),R_Ip_VRO(:,3),R_In_VRO(:,3),Pol3D_VRO(:,3),ATPase2C(:,3),Pentamer_VRO(:,3),...%Viral Replication Organelle 
    RNAPentamer(:,3),P2Filled(:,3),P3Filled(:,3),P4Filled(:,3),P5Filled(:,3),P6Filled(:,3),P7Filled(:,3),P8Filled(:,3),P9Filled(:,3),P10Filled(:,3),P11Filled(:,3),Virion(:,3),...%Virion Assembly
    P2Empty(:,3),P3Empty(:,3),P4Empty(:,3),P5Empty(:,3),P6Empty(:,3),P7Empty(:,3),P8Empty(:,3),P9Empty(:,3),P10Empty(:,3),P11Empty(:,3),EmptyProvirion(:,3),...
    IFNResponseSummary(:,3),ISGProtein(:,3),...%Host-virus Interaction
    TotalPosStrandsSummary(:,3), TotalNegStrandsSummary(:,3), TotalDoubleStrandsSummary(:,3), TotalP1Summary(:,3),...%Summary species
    'VariableNames',ResultsLabels);

MeanTable = table(t,...%Time
    uCVB3(:,4),uCVB3_Defective(:,4),uDAF(:,4),bDAF(:,4),bDAF_Defective(:,4),uDAF_TJ(:,4),bDAF_TJ(:,4),bDAF_Defective_TJ(:,4),uCVB3_TJ(:,4),uCVB3_Defective_TJ(:,4),uCAR(:,4),bCAR(:,4),bCAR_Defective(:,4),R_p_endo(:,4),R_p_endo_Defective(:,4),...%Delivery
    R_p_cyt(:,4),R_p_cyt_Defective(:,4),R_n_cyt(:,4),T_c(:,4),RibAvail(:,4),RibUnavail(:,4),Protease(:,4),Pentamer_cyt(:,4),...%Translation and cytoplasmic species
    R_p_VRO(:,4),R_n_VRO(:,4),R_Ip_VRO(:,4),R_In_VRO(:,4),Pol3D_VRO(:,4),ATPase2C(:,4),Pentamer_VRO(:,4),...%Viral Replication Organelle 
    RNAPentamer(:,4),P2Filled(:,4),P3Filled(:,4),P4Filled(:,4),P5Filled(:,4),P6Filled(:,4),P7Filled(:,4),P8Filled(:,4),P9Filled(:,4),P10Filled(:,4),P11Filled(:,4),Virion(:,4),...%Virion Assembly
    P2Empty(:,4),P3Empty(:,4),P4Empty(:,4),P5Empty(:,4),P6Empty(:,4),P7Empty(:,4),P8Empty(:,4),P9Empty(:,4),P10Empty(:,4),P11Empty(:,4),EmptyProvirion(:,4),...
    IFNResponseSummary(:,4),ISGProtein(:,4),...%Host-virus Interaction
    TotalPosStrandsSummary(:,4), TotalNegStrandsSummary(:,4), TotalDoubleStrandsSummary(:,4), TotalP1Summary(:,4),...%Summary species
    'VariableNames',ResultsLabels);

%MatLab outputs tables to the floating point precision of the workspace so the results need to be rounded back to the precision of the odesolver.
MedianTable.Variables = round(MedianTable.Variables, 6);
UpperQuantileTable.Variables = round(UpperQuantileTable.Variables, 6);
LowerQuantileTable.Variables = round(LowerQuantileTable.Variables, 6);
MeanTable.Variables = round(MeanTable.Variables, 6);

%Assign ResultsTable variable units
unitArray = cell(1,59);
unitArray(:) = {'nM'};
unitArray(54:55) = {''};
MedianTable.Properties.VariableUnits = cat(2,{'Hours'},unitArray);
UpperQuantileTable.Properties.VariableUnits = cat(2,{'Hours'},unitArray);
LowerQuantileTable.Properties.VariableUnits = cat(2,{'Hours'},unitArray);
MeanTable.Properties.VariableUnits = cat(2,{'Hours'},unitArray);

%Assign run parameters to table description
MedianTable.Properties.Description = strjoin(string(RunParameters),', ');
UpperQuantileTable.Properties.Description = strjoin(string(RunParameters),', ');
LowerQuantileTable.Properties.Description = strjoin(string(RunParameters),', ');
SensTable.Properties.Description = strjoin(string(RunParameters),', ');
MeanTable.Properties.Description = strjoin(string(RunParameters),', ');

%Assign the output
if strcmpi(SensitivityAnalysis,'on')
    SensitivitySolutions = SensTable;
else
    SensitivitySolutions = [];
end

MedianSolutions = MedianTable;
UpperQuantileSolutions = UpperQuantileTable;
LowerQuantileSolutions = LowerQuantileTable;
MeanSolutions = MeanTable;

%Export processed data if desired
if strcmpi(ExportData,'on')
    if strcmpi(SensitivityAnalysis,'on')
       writecell(RunParameters ,strjoin({'RunParameters',DataFile},{'_'}));
       writetable(SensTable,DataFile,'WriteVariableNames',true,'WriteRowNames',true);
       writetable(MedianTable,DataFile,'WriteVariableNames',true);
       writetable(UpperQuantileTable,DataFile,'WriteVariableNames',true);
       writetable(LowerQuantileTable,DataFile,'WriteVariableNames',true);
       writetable(MeanTable,DataFile,'WriteVariableNames',true);       
    else
       writecell(RunParameters ,strjoin({'RunParameters',DataFile},{'_'}));
       writetable(MedianTable,strjoin({'MedianResults',DataFile},{'_'}),'WriteVariableNames',true);
       writetable(UpperQuantileTable,strjoin({'UpperQuantileResults',DataFile},{'_'}),'WriteVariableNames',true);
       writetable(LowerQuantileTable,strjoin({'LowerQuantileResults',DataFile},{'_'}),'WriteVariableNames',true);
       writetable(MeanTable,strjoin({'MeanResults',DataFile},{'_'}),'WriteVariableNames',true);
    end
end

%Plot processed data
if strcmpi(PlotResults,'on')
   CVB3ODEPlots(MedianTable,UpperQuantileTable,LowerQuantileTable,MeanTable,'PlotType',plotType,'PopulationSetting',PopulationSetting);
end

%% Outputs run summary in command window

%Displays molecule counts of key species
fprintf('\nPositive Strands = %3.2e molecules, %3.2e nM\n',TotalPosStrands(end)* 6.022*10^23 * CellCytVolume / 10^24,TotalPosStrands(end))
fprintf('Negative Strands = %3.2e molecules, % 3.2e nM\n',TotalNegStrands(end)* 6.022*10^23 * CellCytVolume / 10^24,TotalNegStrands(end))
fprintf('Double Strands = %3.2e molecules, % 3.2e nM\n',TotalDoubleStrandsVRO(end)* 6.022*10^23 * CellCytVolume / 10^24,TotalDoubleStrandsVRO(end))
fprintf('RNA Ratio = %3.2e\n',TotalRNARatio(end));
fprintf('Polyproteins from: Capsid = %3.2e nM, Polymerases = %3.2e nM, Proteases = %3.2e nM, ATPases = %3.2e nM\n',TotalP1(end),TotalP2(end),TotalP3(end),TotalP4(end))
fprintf('Virions = %3.2e molecules, % 3.2e nM\n',Virion(end)* 6.022*10^23 * CellCytVolume / 10^24,Virion(end))
fprintf('Empty Capsid = %3.2e molecules, % 3.2e nM\n',EmptyProvirion(end)* 6.022*10^23 * CellCytVolume / 10^24,EmptyProvirion(end))

end

function [dCdt] = CVB3ODEfunc( t,InitVals,Constants,IFNSwitch,VirResponse,IFNStimulation,IFNStimulationTime )
%Function: Stores the set of ODEs to be run when called from CVB3ODEEval
%
%INPUTS:
    %t: Time
    %InitVals: Vector of simulation initial values
    %Constants: Vector of constants from the ODE solver
    %IFNSwitch: Indicates whether the host-cell anti-viral interferon (IFN) response is enabled. 
    %VirResponse: Indicates whether the viral anti-interferon response is enabled.  
    %IFNStimulation: Indicates if IFN pre-stimulation is simulated.
    %IFNStimulationTime: If IFNStimulation is enabled, indicates the time at which exogenous IFN stimulation occurs. Negative in the case of pre-stimulation.
%    
%OUTPUTS:
    %dCdt: The set of ODEs including time and solutions

%% Imports and assigns all constants and initial values
    
%Assign inputted constants to their respective terms
Constants = num2cell(Constants);
[k_on_DAF,k_off_DAF,k_transloc,k_on_CAR,k_off_CAR,k_internal,InternalVolConv,k_endo_escape, ...
     PolysomeSize,k_T_c_Form,k_Translate,k_P_on,k_P_off,k_N_on,k_N_off,VROVolConv,k_R_Ip_Form,k_N_Transcript,k_P_Transcript,k_R_In_Form, ...
     u_P_cyt,u_P_VRO,u_N_cyt,u_N_VRO,u_T_c,u_VirProt_cyt,u_VirProt_VRO, ...
     k1f_cap,k2f_cap,k1b_cap,k2b_cap,kRNACapBind,kRNACapUnbind,k_Pentamer_on,k_Pentamer_off,u_cap_cyt,u_cap_VRO, ...
     kcat_cleave,Km_cleave,InitRibAvail,u_ISG,ISGformRate,StimISG,ISGBasal,kD_Hill,n_Hill,EC50_Protease,EC50_Translate,OAS_RNAdeg,EC50_RNAdeg,EC50_DetectorDeg,VROFormThreshold] = Constants{:};

%Assign initial conditions to their respective terms
InitVals = num2cell(InitVals);
[uCVB3,uCVB3_Defective,uDAF,bDAF,bDAF_Defective,uDAF_TJ,bDAF_TJ,bDAF_Defective_TJ,uCVB3_TJ,uCVB3_Defective_TJ,uCAR,bCAR,bCAR_Defective,R_p_endo,R_p_endo_Defective, ...
 R_p_cyt,R_p_cyt_Defective,T_c,R_n_cyt,R_p_VRO,R_n_VRO,Pol3D_VRO,R_Ip_VRO,R_In_VRO,ATPase2C, ...
 Pentamer_cyt,Pentamer_VRO,RNAPentamer,P2Filled,P3Filled,P4Filled,P5Filled,P6Filled,P7Filled,P8Filled,P9Filled,P10Filled,P11Filled,Virion, ...
 P2Empty,P3Empty,P4Empty,P5Empty,P6Empty,P7Empty,P8Empty,P9Empty,P10Empty,P11Empty,EmptyProvirion, ...
 RibAvail,RibUnavail,Protease,ISGProtein] = InitVals{:};
   
%% Pre-allocates equations for use in the ODE solver

% VRO formation delay
if Pol3D_VRO < VROFormThreshold * 6e-4 %6e-4 is concentration of 1 molecule in nM
    u_P_VRO = u_P_VRO * VROVolConv;
    u_N_VRO = u_N_VRO * VROVolConv;
    u_VirProt_VRO = u_VirProt_VRO * VROVolConv;
    u_cap_VRO = u_cap_VRO * VROVolConv;
    VROVolConv = 1;
end
 
%Receptor binding equations
DAFform = k_on_DAF * uCVB3 * uDAF; %Formation of DAF-CVB3 complex
DAFdiss = k_off_DAF * bDAF; %Dissociation of DAF-CVB3 complex
DAFtoJunc = k_transloc * bDAF; %Movement of DAF-CVB3 complex to the tight junction
DAFoutJunc = k_transloc * uDAF_TJ; %Movement unbound DAF out of the tight junction
DAFform_Junc = k_on_DAF * uCVB3_TJ * uDAF_TJ; %Formation of DAF-CVB3 complex in the tight junction
DAFdiss_Junc = k_off_DAF * bDAF_TJ; %Dissociation of DAF-CVB3 complex in the tight junction
CARform_DAF = k_on_CAR * bDAF_TJ * uCAR; %Transfer of CVB3 from translocalized bDAF onto uCAR
CARform_uCVB3 = k_on_CAR * uCVB3_TJ * uCAR; %Formation of CAR-CVB3 from uCVB3 in the tight junction
CARdiss = k_off_CAR * bCAR; %Dissociation of CAR-CVB3 complex
Internalization = k_internal * bCAR; %Internalization of the virus, leaves uCAR at the membrane
RNARelease = k_endo_escape * R_p_endo; %Release of RNA from internalized virions

%Receptor binding equations involving replication incompetent virions
DAFform_Defect = k_on_DAF * uCVB3_Defective * uDAF; %Formation of DAF-CVB3 complex
DAFdiss_Defect = k_off_DAF * bDAF_Defective; %Dissociation of DAF-CVB3 complex
DAFtoJunc_Defect = k_transloc * bDAF_Defective; %Movement of DAF-CVB3 complex to the tight junction
DAFform_Junc_Defect = k_on_DAF * uCVB3_Defective_TJ * uDAF_TJ; %Formation of DAF-CVB3 complex in the tight junction
DAFdiss_Junc_Defect = k_off_DAF * bDAF_Defective_TJ; %Dissociation of DAF-CVB3 complex in the tight junction
CARform_DAF_Defect = k_on_CAR * bDAF_Defective_TJ * uCAR; %Transfer of CVB3 from translocalized bDAF onto uCAR
CARform_uCVB3_Defect = k_on_CAR * uCVB3_Defective_TJ * uCAR; %Formation of CAR-CVB3 from uCVB3 in the tight junction
CARdiss_Defect = k_off_CAR * bCAR_Defective; %Dissociation of CAR-CVB3 complex
Internalization_Defect = k_internal * bCAR_Defective; %Internalization of the virus, leaves uCAR at the membrane
RNARelease_Defect = k_endo_escape * R_p_endo_Defective; %Release of RNA from internalized virions

%Replication equations
TranslateForm = k_T_c_Form * (RibAvail - T_c) * R_p_cyt; %Formation of a translation complex
TranslateDiss = k_Translate * T_c; %Translation completion and complex dissociation
TranslateDissProt = TranslateDiss; %Separates Protease translation rate for IFN response
PosEnterVRO = k_P_on * R_p_cyt; %%Positive Strand entering the VRO
PosExitVRO = k_P_off * R_p_VRO; %Positive Strand exiting the VRO
MinEnterVRO = k_N_on * R_n_cyt; %Minus Strand entering the VRO
MinExitVRO = k_N_off * R_n_VRO; %Minus Strand exiting the VRO
PosComplexFormVRO = k_R_Ip_Form * R_p_VRO * Pol3D_VRO; %Formation of plus-strand RNA intermediate complexes in the VRO
MinStrandFormVRO = k_N_Transcript * R_Ip_VRO; %Synthesis of negative strands in the VRO
PosStrandFormVRO = k_P_Transcript * R_In_VRO; %Synthesis of positive strands in the VRO
MinComplexFormVRO = k_R_In_Form * R_n_VRO * Pol3D_VRO; %Formation of minus-strand RNA intermediate complexes in the VRO
PosCytDeg = u_P_cyt * R_p_cyt; %Positive Strand degrading in the cytoplasm
PosCytDefectDeg = u_P_cyt * R_p_cyt_Defective; %Defective positive strand degrading in the cytoplasm
PosVRODeg = u_P_VRO * R_p_VRO; %Degradation of positive strands in the VRO
MinCytDeg = u_N_cyt * R_n_cyt; %Minus Strand degrading in the cytoplasm
MinVRODeg = u_N_VRO * R_n_VRO; %Degradation of negative strands in the VRO
TranslateDeg = u_T_c * T_c; %Degradation of translation complexes
Pol3DVRODeg = u_VirProt_VRO * Pol3D_VRO; %Degradation of replication enzymes in the VRO
PosComplexDeg = u_P_VRO * R_Ip_VRO; %Degradation of plus-strand RNA intermediate complexes in the VRO
MinComplexDeg = u_N_VRO * R_In_VRO; %Degradation of minus-strand RNA intermediate complexes in the VRO

%Capsid assembly equations
Pent2EmptyAssembly = k1f_cap * Pentamer_VRO^2; %Assembly step for empty capsid molecules (2 unbound pentamers used)
Pent2EmptyDisassembly =  k1b_cap * P2Empty; %Disassembly step for empty capsid molecules in which both unbound pentamers are lost
Pent3EmptyAssembly = k1f_cap * P2Empty * Pentamer_VRO; %Assembly step for empty capsid molecules in which an unbound pentamer is added
Pent3EmptyDisassembly =  k1b_cap * P3Empty; %Disassembly step for empty capsid molecules in which an unbound pentamer is lost
Pent4EmptyAssembly = k1f_cap * P3Empty * Pentamer_VRO; %Assembly step for empty capsid molecules in which an unbound pentamer is added
Pent4EmptyDisassembly =  k1b_cap * P4Empty; %Disassembly step for empty capsid molecules in which an unbound pentamer is lost
Pent5EmptyAssembly = k1f_cap * P4Empty * Pentamer_VRO; %Assembly step for empty capsid molecules in which an unbound pentamer is added
Pent5EmptyDisassembly =  k1b_cap * P5Empty; %Disassembly step for empty capsid molecules in which an unbound pentamer is lost
Pent6EmptyAssembly = k1f_cap * P5Empty * Pentamer_VRO; %Assembly step for empty capsid molecules in which an unbound pentamer is added
Pent6EmptyDisassembly =  k1b_cap * P6Empty; %Disassembly step for empty capsid molecules in which an unbound pentamer is lost
Pent7EmptyAssembly = k1f_cap * P6Empty * Pentamer_VRO; %Assembly step for empty capsid molecules in which an unbound pentamer is added
Pent7EmptyDisassembly =  k1b_cap * P7Empty; %Disassembly step for empty capsid molecules in which an unbound pentamer is lost
Pent8EmptyAssembly = k1f_cap * P7Empty * Pentamer_VRO; %Assembly step for empty capsid molecules in which an unbound pentamer is added
Pent8EmptyDisassembly =  k1b_cap * P8Empty; %Disassembly step for empty capsid molecules in which an unbound pentamer is lost
Pent9EmptyAssembly = k1f_cap * P8Empty * Pentamer_VRO; %Assembly step for empty capsid molecules in which an unbound pentamer is added
Pent9EmptyDisassembly =  k1b_cap * P9Empty; %Disassembly step for empty capsid molecules in which an unbound pentamer is lost
Pent10EmptyAssembly = k1f_cap * P9Empty * Pentamer_VRO; %Assembly step for empty capsid molecules in which an unbound pentamer is added
Pent10EmptyDisassembly =  k1b_cap * P10Empty; %Disassembly step for empty capsid molecules in which an unbound pentamer is lost
Pent11EmptyAssembly = k1f_cap * P10Empty * Pentamer_VRO; %Assembly step for empty capsid molecules in which an unbound pentamer is added
Pent11EmptyDisassembly =  k1b_cap * P11Empty; %Disassembly step for empty capsid molecules in which an unbound pentamer is lost
EmpProvirionAssembly = k1f_cap * P11Empty * Pentamer_VRO; %Formation of empty provirions from 12 pentamers
EmpProvirionDisassembly = k1b_cap * EmptyProvirion; %Dissociation of empty provirions into 12 pentamers
PentEnterVRO = k_Pentamer_on * Pentamer_cyt * ATPase2C; %Pentamer entering the VRO * VROVolConv
PentExitVRO = k_Pentamer_off * Pentamer_VRO; %Pentamer exiting the VRO
RNAPentBinding = kRNACapBind * Pentamer_VRO * R_p_VRO; %Formation of RNA-Pentamer complexes from species in the VRO
RNAPentUnbinding = kRNACapUnbind * RNAPentamer; %Dissocation of RNA-Pentamer complexes into the cytoplasm
Pent2FilledAssembly = k1f_cap * RNAPentamer * Pentamer_VRO; %Assembly step for filled capsid molecules (1 unbound and 1 RNA-bound pentamer used)
Pent2FilledDisassembly =  k1b_cap * P2Filled; %Disassembly step for filled capsid molecules in which both the unbound and RNA-bound pentamers are lost
Pent3FilledAssembly = k1f_cap * P2Filled * Pentamer_VRO; %Assembly step for filled capsid molecules in which an unbound pentamer is added 
Pent3FilledDisassembly =  k1b_cap * P3Filled; %Disassembly step for filled capsid molecules in which an unbound pentamer is lost
Pent4FilledAssembly = k1f_cap * P3Filled * Pentamer_VRO; %Assembly step for filled capsid molecules in which an unbound pentamer is added 
Pent4FilledDisassembly =  k1b_cap * P4Filled; %Disassembly step for filled capsid molecules in which an unbound pentamer is lost
Pent5FilledAssembly = k1f_cap * P4Filled * Pentamer_VRO; %Assembly step for filled capsid molecules in which an unbound pentamer is added 
Pent5FilledDisassembly =  k1b_cap * P5Filled; %Disassembly step for filled capsid molecules in which an unbound pentamer is lost
Pent6FilledAssembly = k1f_cap * P5Filled * Pentamer_VRO; %Assembly step for filled capsid molecules in which an unbound pentamer is added 
Pent6FilledDisassembly =  k1b_cap * P6Filled; %Disassembly step for filled capsid molecules in which an unbound pentamer is lost
Pent7FilledAssembly = k1f_cap * P6Filled * Pentamer_VRO; %Assembly step for filled capsid molecules in which an unbound pentamer is added 
Pent7FilledDisassembly =  k1b_cap * P7Filled; %Disassembly step for filled capsid molecules in which an unbound pentamer is lost
Pent8FilledAssembly = k1f_cap * P7Filled * Pentamer_VRO; %Assembly step for filled capsid molecules in which an unbound pentamer is added 
Pent8FilledDisassembly =  k1b_cap * P8Filled; %Disassembly step for filled capsid molecules in which an unbound pentamer is lost
Pent9FilledAssembly = k1f_cap * P8Filled * Pentamer_VRO; %Assembly step for filled capsid molecules in which an unbound pentamer is added 
Pent9FilledDisassembly =  k1b_cap * P9Filled; %Disassembly step for filled capsid molecules in which an unbound pentamer is lost
Pent10FilledAssembly = k1f_cap * P9Filled * Pentamer_VRO; %Assembly step for filled capsid molecules in which an unbound pentamer is added 
Pent10FilledDisassembly =  k1b_cap * P10Filled; %Disassembly step for filled capsid molecules in which an unbound pentamer is lost
Pent11FilledAssembly = k1f_cap * P10Filled * Pentamer_VRO; %Assembly step for filled capsid molecules in which an unbound pentamer is added 
Pent11FilledDisassembly =  k1b_cap * P11Filled; %Disassembly step for filled capsid molecules in which an unbound pentamer is lost
VirionAssembly = k1f_cap * P11Filled * Pentamer_VRO; %Formation of 12-unit, completed virions from 11-unit filled capsid
VirionDisassembly = 0 * k1b_cap * Virion; %Dissociation of fully encapsidated, RNA-containing virion is assumed to be irreversible
Pent2EmptyFilling = k2f_cap * P2Empty * RNAPentamer; %Assembly step for empty capsid in which an RNA-bound pentamer is added
Pent3FilledUnfilling = k2b_cap * P3Filled; %Disassembly step for filled capsid in which an RNA-bound pentamer is lost
Pent3EmptyFilling = k2f_cap * P3Empty * RNAPentamer; %Assembly step for empty capsid in which an RNA-bound pentamer is added
Pent4FilledUnfilling = k2b_cap * P4Filled; %Disassembly step for filled capsid in which an RNA-bound pentamer is lost
Pent4EmptyFilling = k2f_cap * P4Empty * RNAPentamer; %Assembly step for empty capsid in which an RNA-bound pentamer is added
Pent5FilledUnfilling = k2b_cap * P5Filled; %Disassembly step for filled capsid in which an RNA-bound pentamer is lost
Pent5EmptyFilling = k2f_cap * P5Empty * RNAPentamer; %Assembly step for empty capsid in which an RNA-bound pentamer is added
Pent6FilledUnfilling = k2b_cap * P6Filled; %Disassembly step for filled capsid in which an RNA-bound pentamer is lost
Pent6EmptyFilling = k2f_cap * P6Empty * RNAPentamer; %Assembly step for empty capsid in which an RNA-bound pentamer is added
Pent7FilledUnfilling = k2b_cap * P7Filled; %Disassembly step for filled capsid in which an RNA-bound pentamer is lost
Pent7EmptyFilling = k2f_cap * P7Empty * RNAPentamer; %Assembly step for empty capsid in which an RNA-bound pentamer is added
Pent8FilledUnfilling = k2b_cap * P8Filled; %Disassembly step for filled capsid in which an RNA-bound pentamer is lost
Pent8EmptyFilling = k2f_cap * P8Empty * RNAPentamer; %Assembly step for empty capsid in which an RNA-bound pentamer is added
Pent9FilledUnfilling = k2b_cap * P9Filled; %Disassembly step for filled capsid in which an RNA-bound pentamer is lost
Pent9EmptyFilling = k2f_cap * P9Empty * RNAPentamer; %Assembly step for empty capsid in which an RNA-bound pentamer is added
Pent10FilledUnfilling = k2b_cap * P10Filled; %Disassembly step for filled capsid in which an RNA-bound pentamer is lost
Pent10EmptyFilling = k2f_cap * P10Empty * RNAPentamer; %Assembly step for empty capsid in which an RNA-bound pentamer is added
Pent11FilledUnfilling = k2b_cap * P11Filled; %Disassembly step for filled capsid in which an RNA-bound pentamer is lost
Pent11EmptyFilling = k2f_cap * P11Empty * RNAPentamer; %Formation of 12-unit, completed virions from 11-unit empty capsid
PentamerCytDeg = u_cap_cyt * Pentamer_cyt; %Degradation of pentamers in the cytoplasm 
PentamerVRODeg = u_cap_VRO * Pentamer_VRO; %Degradation of pentamers in the VRO 
RNAPentamerDeg = u_cap_VRO * RNAPentamer; %Degradation of RNA-Pentamer complexes 
%All encapsidation intermediates were assumed not to degrade

%EIF4G and PABP cleavage equations
RiboChange = kcat_cleave * Protease * RibUnavail * PolysomeSize / (RibUnavail * PolysomeSize + Km_cleave); %Michaelis-Menten equation for protease activity against eIF4G 
ProtCytDeg = u_VirProt_cyt * Protease; %Degradation of viral proteases in the cytoplasm

%IFN-B response equations
TotalDoubleStrands = (R_In_VRO + R_Ip_VRO); %Summed for subsequent use in Viral detection equation

%Set VirDetection (dsRNA sensing mediated IFN response) and StimISG (exogenous IFN stimulation) depending on the amount of dsRNA and the simulation time respectively.
if strcmpi(IFNSwitch,'on') %If the interferon response module is active
    
    VirDetection = ((TotalDoubleStrands)^n_Hill)/(kD_Hill^n_Hill + (TotalDoubleStrands)^n_Hill); %VirDetection is defined by a Hill equation for detection of dsRNA
    
    if strcmpi(IFNStimulation,'on') %If there is exogenous interferon stimulation
        if IFNStimulationTime <= 0 % and if the stimulation time occurs prior to infection (pre-stimulation)
            StimISG = 1; % then StimISG is always maximally on.
            VirDetection = 0; %dsRNA mediated IFN response is superseded by the exogenous response.
        elseif IFNStimulationTime > 0 && t < IFNStimulationTime %If the time of stimulation has not occured yet,
            StimISG = 0; %then StimISG is off.
        elseif IFNStimulationTime > 0 && t >= IFNStimulationTime %If the time of stimulation has occured, 
            StimISG = 1; %then StimISG is maximally on.
            VirDetection = 0;%dsRNA mediated IFN response is superseded by the exogenous response.
        end
    end
    
    if strcmpi(VirResponse,'on')
        VirDetection = VirDetection*(1 - Protease/(Protease + EC50_DetectorDeg)); %Scales down viral detection for IFN response if the virus's response to the IFN response is active.
    end    
else
    VirDetection = 0; %Sets detection to 0 in the event of no IFN response
end

ISGform = (VirDetection + StimISG) * ISGformRate * RibUnavail; %Formation of ISGs can be induced by either VirDetection or exogenous StimISG.
ISGDegradation = u_ISG * ISGProtein; %Degradation of ISG proteins in the cytoplasm
ISGBasalRate = u_ISG * ISGBasal; %Maintains the basal level of ISG proteins against degradation
if strcmpi(IFNSwitch,'on') %Impedes virus processes if IFN response is turned on
    TranslateForm = TranslateForm * (1 - ISGProtein/(EC50_Translate + ISGProtein)); %Formation of translation complexes inhibited by interferon
    TranslateDissProt = TranslateDissProt * (1 - ISGProtein/(EC50_Protease + ISGProtein)); %ISG15 deactivation of proteases by ISGylation
    
    PosCytDeg = PosCytDeg * (1 + (OAS_RNAdeg-1)*ISGProtein/(EC50_RNAdeg + ISGProtein));   %Ramp degradation up 5-fold higher as ISGs are expressed, modeling OASs
    PosCytDefectDeg = PosCytDeg * (1 + (OAS_RNAdeg-1)*ISGProtein/(EC50_RNAdeg + ISGProtein));   %Ramp degradation up 5-fold higher as ISGs are expressed, modeling OASs
    PosVRODeg = PosVRODeg * (1 + (OAS_RNAdeg-1)*ISGProtein/(EC50_RNAdeg + ISGProtein));   %Ramp degradation up 5-fold higher as ISGs are expressed, modeling OASs
    MinCytDeg = MinCytDeg * (1 + (OAS_RNAdeg-1)*ISGProtein/(EC50_RNAdeg + ISGProtein));   %Ramp degradation up 5-fold higher as ISGs are expressed, modeling OASs
    MinVRODeg = MinVRODeg * (1 + (OAS_RNAdeg-1)*ISGProtein/(EC50_RNAdeg + ISGProtein));   %Ramp degradation up 5-fold higher as ISGs are expressed, modeling OASs
    TranslateDeg = TranslateDeg * (1 + (OAS_RNAdeg-1)*ISGProtein/(EC50_RNAdeg + ISGProtein));   %Ramp degradation up 5-fold higher as ISGs are expressed, modeling OASs
end


%% Defining the system of ODEs

dCdt = [DAFdiss - DAFform; %uCVB3
    DAFdiss_Defect - DAFform_Defect; %uCVB3_Defective
    DAFdiss - DAFform - DAFform_Defect + DAFdiss_Defect + DAFoutJunc; %uDAF
    DAFform - DAFdiss - DAFtoJunc; %bDAF
    DAFform_Defect - DAFdiss_Defect - DAFtoJunc_Defect; %bDAF_Defective
    CARform_DAF - DAFoutJunc + DAFdiss_Junc - DAFform_Junc + CARform_DAF_Defect + DAFdiss_Junc_Defect - DAFform_Junc_Defect; %uDAF_TJ
    DAFtoJunc + DAFform_Junc - DAFdiss_Junc - CARform_DAF; %bDAF_TJ
    DAFtoJunc_Defect + DAFform_Junc_Defect - DAFdiss_Junc_Defect - CARform_DAF_Defect; %bDAF_Defective_TJ
    DAFdiss_Junc + CARdiss - CARform_uCVB3 - DAFform_Junc; %uCVB3_TJ
    DAFdiss_Junc_Defect + CARdiss_Defect - CARform_uCVB3_Defect - DAFform_Junc_Defect; %uCVB3_Defective_TJ
    CARdiss - CARform_DAF - CARform_uCVB3 + CARdiss_Defect - CARform_DAF_Defect - CARform_uCVB3_Defect; %uCAR
    CARform_DAF + CARform_uCVB3 - CARdiss - Internalization; %bCAR
    CARform_DAF_Defect + CARform_uCVB3_Defect - CARdiss_Defect - Internalization_Defect; %bCAR_Defective
    InternalVolConv * Internalization - RNARelease; %R_p_endo
    InternalVolConv * Internalization_Defect - RNARelease_Defect; %R_p_endo_Defective
    RNARelease + PosExitVRO / VROVolConv + RNAPentUnbinding / VROVolConv - TranslateForm - PosEnterVRO - PosCytDeg; %R_p_cyt
    RNARelease_Defect - PosCytDefectDeg; %R_p_cyt_Defective
    TranslateForm - TranslateDiss/PolysomeSize - TranslateDeg; %T_c
    MinExitVRO / VROVolConv - MinEnterVRO - MinCytDeg; %R_n_cyt
    TranslateDiss/PolysomeSize * VROVolConv + PosStrandFormVRO + MinStrandFormVRO - PosComplexFormVRO - RNAPentBinding + PosEnterVRO * VROVolConv - PosExitVRO - PosVRODeg; %R_p_VRO
    MinStrandFormVRO + MinEnterVRO * VROVolConv - MinExitVRO - MinComplexFormVRO - MinVRODeg; %R_n_VRO
    TranslateDiss * VROVolConv + MinStrandFormVRO - PosComplexFormVRO - MinComplexFormVRO + PosComplexDeg + MinComplexDeg - Pol3DVRODeg; %Pol3D_VRO
    PosComplexFormVRO - MinStrandFormVRO - PosComplexDeg; %R_Ip_VRO
    MinComplexFormVRO - MinComplexDeg; %R_In_VRO
    4/5*TranslateDiss * VROVolConv + PentExitVRO - PentEnterVRO * VROVolConv + RNAPentBinding ...
        + Pent2FilledAssembly + Pent2EmptyAssembly + Pent3FilledAssembly + Pent3EmptyAssembly + Pent4FilledAssembly + Pent4EmptyAssembly + Pent5FilledAssembly + Pent5EmptyAssembly ...
        + Pent6FilledAssembly + Pent6EmptyAssembly + Pent7FilledAssembly + Pent7EmptyAssembly + Pent8FilledAssembly + Pent8EmptyAssembly + Pent9FilledAssembly + Pent9EmptyAssembly ...
        + Pent10FilledAssembly + Pent10EmptyAssembly + Pent11FilledAssembly + Pent11EmptyAssembly + VirionAssembly + EmpProvirionAssembly ...
        + Pent2EmptyFilling + Pent3EmptyFilling + Pent4EmptyFilling + Pent5EmptyFilling + Pent6EmptyFilling + Pent7EmptyFilling + Pent8EmptyFilling + Pent9EmptyFilling + Pent10EmptyFilling + Pent11EmptyFilling ...
        - 1/3*Pent3FilledUnfilling - 1/4*Pent4FilledUnfilling - 1/5*Pent5FilledUnfilling - 1/6*Pent6FilledUnfilling - 1/7*Pent7FilledUnfilling - 1/8*Pent8FilledUnfilling - 1/9*Pent9FilledUnfilling ...
        - 1/10*Pent10FilledUnfilling - 1/11*Pent11FilledUnfilling; %ATPase2C (4/5 because 1 is made per polyprotein, but 1/5 is allocated as a Pentamer_VRO
    RNAPentUnbinding / VROVolConv + PentExitVRO / VROVolConv - PentEnterVRO - PentamerCytDeg ...
        + (Pent2FilledDisassembly + Pent2EmptyDisassembly + 2/3*Pent3FilledDisassembly + Pent3EmptyDisassembly + 3/4*Pent4FilledDisassembly + Pent4EmptyDisassembly + 4/5*Pent5FilledDisassembly + Pent5EmptyDisassembly ...
        + 5/6*Pent6FilledDisassembly + Pent6EmptyDisassembly + 6/7*Pent7FilledDisassembly + Pent7EmptyDisassembly + 7/8*Pent8FilledDisassembly + Pent8EmptyDisassembly + 8/9*Pent9FilledDisassembly + Pent9EmptyDisassembly ...
        + 9/10*Pent10FilledDisassembly + Pent10EmptyDisassembly + 10/11*Pent11FilledDisassembly + Pent11EmptyDisassembly + VirionDisassembly + EmpProvirionDisassembly)/VROVolConv; %Pentamer_cyt
    TranslateDiss/5 * VROVolConv + PentEnterVRO * VROVolConv - PentExitVRO - RNAPentBinding - PentamerVRODeg + Pent2EmptyDisassembly ...
        - Pent2FilledAssembly - 2*Pent2EmptyAssembly - Pent3FilledAssembly - Pent3EmptyAssembly - Pent4FilledAssembly - Pent4EmptyAssembly - Pent5FilledAssembly - Pent5EmptyAssembly ...
        - Pent6FilledAssembly - Pent6EmptyAssembly - Pent7FilledAssembly - Pent7EmptyAssembly - Pent8FilledAssembly - Pent8EmptyAssembly - Pent9FilledAssembly - Pent9EmptyAssembly ...
        - Pent10FilledAssembly - Pent10EmptyAssembly - Pent11FilledAssembly - Pent11EmptyAssembly - VirionAssembly - EmpProvirionAssembly; %Pentamer_VRO = Pentamer:ATPase2C
    RNAPentBinding - RNAPentUnbinding - RNAPentamerDeg - Pent2FilledAssembly + Pent2FilledDisassembly - Pent2EmptyFilling ...
        + 1/3*Pent3FilledUnfilling - Pent3EmptyFilling + 1/4*Pent4FilledUnfilling - Pent4EmptyFilling + 1/5*Pent5FilledUnfilling - Pent5EmptyFilling + 1/6*Pent6FilledUnfilling - Pent6EmptyFilling ...
        + 1/7*Pent7FilledUnfilling - Pent7EmptyFilling + 1/8*Pent8FilledUnfilling - Pent8EmptyFilling + 1/9*Pent9FilledUnfilling - Pent9EmptyFilling + 1/10*Pent10FilledUnfilling - Pent10EmptyFilling ...
        + 1/11*Pent11FilledUnfilling - Pent11EmptyFilling; %RNAPentamer = Pentamer:R_p_VRO
    Pent2FilledAssembly - Pent2FilledDisassembly + 2/3*Pent3FilledDisassembly - Pent3FilledAssembly; %P2Filled = 2xPentamer:R_p_VRO
    Pent3FilledAssembly - 2/3*Pent3FilledDisassembly + 3/4*Pent4FilledDisassembly - Pent4FilledAssembly - 1/3*Pent3FilledUnfilling + Pent2EmptyFilling; %P3Filled = 3xPentamer:R_p_VRO
    Pent4FilledAssembly - 3/4*Pent4FilledDisassembly + 4/5*Pent5FilledDisassembly - Pent5FilledAssembly - 1/4*Pent4FilledUnfilling + Pent3EmptyFilling; %P4Filled = 4xPentamer:R_p_VRO
    Pent5FilledAssembly - 4/5*Pent5FilledDisassembly + 5/6*Pent6FilledDisassembly - Pent6FilledAssembly - 1/5*Pent5FilledUnfilling + Pent4EmptyFilling; %P5Filled = 5xPentamer:R_p_VRO
    Pent6FilledAssembly - 5/6*Pent6FilledDisassembly + 6/7*Pent7FilledDisassembly - Pent7FilledAssembly - 1/6*Pent6FilledUnfilling + Pent5EmptyFilling; %P6Filled = 6xPentamer:R_p_VRO
    Pent7FilledAssembly - 6/7*Pent7FilledDisassembly + 7/8*Pent8FilledDisassembly - Pent8FilledAssembly - 1/7*Pent7FilledUnfilling + Pent6EmptyFilling; %P7Filled = 7xPentamer:R_p_VRO
    Pent8FilledAssembly - 7/8*Pent8FilledDisassembly + 8/9*Pent9FilledDisassembly - Pent9FilledAssembly - 1/8*Pent8FilledUnfilling + Pent7EmptyFilling; %P8Filled = 8xPentamer:R_p_VRO
    Pent9FilledAssembly - 8/9*Pent9FilledDisassembly + 9/10*Pent10FilledDisassembly - Pent10FilledAssembly - 1/9*Pent9FilledUnfilling + Pent8EmptyFilling; %P9Filled = 9xPentamer:R_p_VRO
    Pent10FilledAssembly - 9/10*Pent10FilledDisassembly + 10/11*Pent11FilledDisassembly - Pent11FilledAssembly - 1/10*Pent10FilledUnfilling + Pent9EmptyFilling; %P10Filled = 10xPentamer:R_p_VRO
    Pent11FilledAssembly - 10/11*Pent11FilledDisassembly + VirionDisassembly - VirionAssembly - 1/11*Pent11FilledUnfilling + Pent10EmptyFilling; %P11Filled = 11xPentamer:R_p_VRO
    VirionAssembly - VirionDisassembly + Pent11EmptyFilling; %Virion = 12xPentamer:R_p_VRO
    Pent2EmptyAssembly - Pent2EmptyDisassembly + Pent3EmptyDisassembly - Pent3EmptyAssembly + 1/3*Pent3FilledUnfilling - Pent2EmptyFilling; %P2Empty = 2xPentamer:ATPase2C
    Pent3EmptyAssembly - Pent3EmptyDisassembly + Pent4EmptyDisassembly - Pent4EmptyAssembly + 1/4*Pent4FilledUnfilling - Pent3EmptyFilling; %P3Empty = 3xPentamer:ATPase2C
    Pent4EmptyAssembly - Pent4EmptyDisassembly + Pent5EmptyDisassembly - Pent5EmptyAssembly + 1/5*Pent5FilledUnfilling - Pent4EmptyFilling; %P4Empty = 4xPentamer:ATPase2C
    Pent5EmptyAssembly - Pent5EmptyDisassembly + Pent6EmptyDisassembly - Pent6EmptyAssembly + 1/6*Pent6FilledUnfilling - Pent5EmptyFilling; %P5Empty = 5xPentamer:ATPase2C
    Pent6EmptyAssembly - Pent6EmptyDisassembly + Pent7EmptyDisassembly - Pent7EmptyAssembly + 1/7*Pent7FilledUnfilling - Pent6EmptyFilling; %P6Empty = 6xPentamer:ATPase2C
    Pent7EmptyAssembly - Pent7EmptyDisassembly + Pent8EmptyDisassembly - Pent8EmptyAssembly + 1/8*Pent8FilledUnfilling - Pent7EmptyFilling; %P7Empty = 7xPentamer:ATPase2C
    Pent8EmptyAssembly - Pent8EmptyDisassembly + Pent9EmptyDisassembly - Pent9EmptyAssembly + 1/9*Pent9FilledUnfilling - Pent8EmptyFilling; %P8Empty = 8xPentamer:ATPase2C
    Pent9EmptyAssembly - Pent9EmptyDisassembly + Pent10EmptyDisassembly - Pent10EmptyAssembly + 1/10*Pent10FilledUnfilling - Pent9EmptyFilling; %P9Empty = 9xPentamer:ATPase2C
    Pent10EmptyAssembly - Pent10EmptyDisassembly + Pent11EmptyDisassembly - Pent11EmptyAssembly + 1/11*Pent11FilledUnfilling - Pent10EmptyFilling; %P10Empty = 10xPentamer:ATPase2C
    Pent11EmptyAssembly - Pent11EmptyDisassembly + EmpProvirionDisassembly - EmpProvirionAssembly - Pent11EmptyFilling; %P11Empty = 11xPentamer:ATPase2C   
    EmpProvirionAssembly - EmpProvirionDisassembly; %EmptyProvirion = 12xPentamer:ATPase2C
    RiboChange; %RibAvail
    -RiboChange; %RibUnavail
    TranslateDissProt - ProtCytDeg; %Protease
    ISGform + ISGBasalRate - ISGDegradation]; %ISGProtein

end

function [] = CVB3ODEPlots(MedianTable,UpperQuantileTable,LowerQuantileTable,MeanTable,varargin)
%function [] = CVB3ODEPlots(MedianTable,UpperQuantileTable,LowerQuantileTable,varargin)
%Function: Plots specified figures
%
%INPUTS:
    %MedianTable: Median results table of CVB3 infection simulation
    %UpperQuantileTable: Upper quantile results table of CVB3 infection simulation
    %LowerTable: Lower quantile results table of CVB3 infection simulation
    %MeanTable: Mean results table of CVB3 infection simulation
    %PlotType: linear or semilog specification for the plots
    %PlotOutputs: vector of specific plots desired
    
%% Parse Inputs

% Set defaults
defaultPlotType = 'semilog';
defaultPlotOutputs = 'All';
defaultPopulationSetting = 'Single Cell';

CVB3ODEPlotsparser = inputParser;

% Set general criteria for inputs
validInput = @(x) istable(x);
validPlotType = @(x) strcmpi(x,'linear') || strcmpi(x,'semilog');
validPlotOutputs = @(x) iscell(x);
validPopulationString = @(x) strcmpi(x,'Single Cell') || strcmpi(x,'Population');

% Set parser options and valid input criteria
addRequired(CVB3ODEPlotsparser,'MedianTable',validInput);
addRequired(CVB3ODEPlotsparser,'UpperQuantileTable',validInput);
addRequired(CVB3ODEPlotsparser,'LowerQuantileTable',validInput);
addRequired(CVB3ODEPlotsparser,'MeanTable',validInput);
addOptional(CVB3ODEPlotsparser,'PlotType',defaultPlotType,validPlotType);
addOptional(CVB3ODEPlotsparser,'PlotOutputs',defaultPlotOutputs,validPlotOutputs);
addOptional(CVB3ODEPlotsparser,'PopulationSetting',defaultPopulationSetting,validPopulationString);

% Extract parsed inputs
parse(CVB3ODEPlotsparser,MedianTable,UpperQuantileTable,LowerQuantileTable,MeanTable,varargin{:});
MedianTable = CVB3ODEPlotsparser.Results.MedianTable;
UpperQuantileTable = CVB3ODEPlotsparser.Results.UpperQuantileTable;
LowerQuantileTable = CVB3ODEPlotsparser.Results.LowerQuantileTable;
MeanTable = CVB3ODEPlotsparser.Results.MeanTable;
PlotType = CVB3ODEPlotsparser.Results.PlotType;
PlotOutputs = CVB3ODEPlotsparser.Results.PlotOutputs;
PopulationSetting = CVB3ODEPlotsparser.Results.PopulationSetting;

%% Creates function for more concise plot settings

function [] = font_ax(t,xlab,ylab,fsize_ax,fweight,bwidth,cbar_flag)
    %Function: Sets features of the plot display
    %
    %INPUTS:
        %t: Plot title
        %xlab: X-axis label
        %ylab: Y-axis label
        %fsize_ax: Sets the figure's font size
        %fweight: Sets font to bold if desired
        %bwidth: Thickness of the lines in the display
        %cbar_flag: 1 adds a color bar, 0 does not

    title(t,'FontSize',fsize_ax+5,'FontWeight',fweight);
    % title(['Selected Slice (Depth ',num2str(d_ind),'mm)'],'FontSize',15,'FontWeight','bold');
    % xh=xlab;
    % yh=ylab;
    xh=xlabel(xlab);
    yh=ylabel(ylab);
    set([xh,yh],'FontSize',fsize_ax,'FontWeight','bold');
    set(gca,'FontSize',fsize_ax,'FontWeight','bold','LineWidth',bwidth);
    if(cbar_flag==1)
        h=colorbar;
        set(h,'FontSize',fsize_ax,'FontWeight','bold','LineWidth',3);
    end
end

%% Plotting

%Plotting and caption variables
Time = table2array(MedianTable(:,{'Time'}));
MOI = cell2mat(extractBetween(MedianTable.Properties.Description,'MOI: ',','));
VarNames = MedianTable.Properties.VariableNames;

if strcmpi(PlotOutputs,'All')
    %Default Plots
    
    %Delivery
    figure
    sgtitle(sprintf('CVB3 Receptor Binding and Intracellular Delivery at an MOI of %s',MOI),'FontSize',12,'FontWeight','bold')
    for i = 2:16
        subplot(3,5,i-1)
        Median = table2array(MedianTable(:,{VarNames{i}}));
        UQ = table2array(UpperQuantileTable(:,{VarNames{i}}));
        LQ = table2array(LowerQuantileTable(:,{VarNames{i}}));
        Mean = table2array(MeanTable(:,{VarNames{i}}));
        if strcmpi(PlotType,'linear') == 1
            hold on
            MedianPlot = plot(Time,Median,'r-','LineWidth',2);
            if strcmpi(PopulationSetting,'Population') %Population mode plots the mean as well
                MeanPlot = plot(Time,Mean,'r:','LineWidth',2);
                legend([MedianPlot, MeanPlot], 'Median','Mean')
            elseif strcmpi(PopulationSetting,'Single Cell') %Only plot quantiles in Single-Cell mode
                plot(Time,UQ,'r--','LineWidth',0.75)
                plot(Time,LQ,'r--','LineWidth',0.75)
            end
            hold off
        elseif strcmpi(PlotType,'semilog') == 1
            MedianPlot=semilogy(Time,max(Median,0.000001),'r-','LineWidth',2);
            hold on
            if strcmpi(PopulationSetting,'Population') %Population mode plots the mean as well
                MeanPlot=semilogy(Time,max(Mean,0.000001),'r:','LineWidth',2);
                legend([MedianPlot, MeanPlot], 'Median','Mean')
            elseif strcmpi(PopulationSetting,'Single Cell') %Only plot quantiles in Single-Cell mode
                semilogy(Time,max(UQ,0.000001),'r--','LineWidth',0.75)
                semilogy(Time,max(LQ,0.000001),'r--','LineWidth',0.75)
            end
            hold off
        end
        font_ax(sprintf('%s',VarNames{i}),'Time (h)',MedianTable.Properties.VariableUnits{i},10,'bold',2.0,0)
    end
    
    %Translation and Cytoplasmic Species
    figure
    sgtitle(sprintf('Viral Translation and Cytoplasmic Species at an MOI of %s',MOI),'FontSize',12,'FontWeight','bold')
    for i = 17:24
        subplot(2,4,i-16)
        Median = table2array(MedianTable(:,{VarNames{i}}));
        UQ = table2array(UpperQuantileTable(:,{VarNames{i}}));
        LQ = table2array(LowerQuantileTable(:,{VarNames{i}}));
        Mean = table2array(MeanTable(:,{VarNames{i}}));
        if strcmpi(PlotType,'linear') == 1
            hold on
            MedianPlot=plot(Time,Median,'r-','LineWidth',2);
            if strcmpi(PopulationSetting,'Population') %Population mode plots the mean as well
                MeanPlot=plot(Time,Mean,'r:','LineWidth',2);
                legend([MedianPlot, MeanPlot], 'Median','Mean')
                
            elseif strcmpi(PopulationSetting,'Single Cell') %Only plot quantiles in Single-Cell mode
                plot(Time,UQ,'r--','LineWidth',0.75)
                plot(Time,LQ,'r--','LineWidth',0.75)
            end
            hold off
        elseif strcmpi(PlotType,'semilog') == 1
            MedianPlot=semilogy(Time,max(Median,0.000001),'r-','LineWidth',2);
            hold on
            if strcmpi(PopulationSetting,'Population') %Population mode plots the mean as well
                MeanPlot=semilogy(Time,max(Mean,0.000001),'r:','LineWidth',2);
                legend([MedianPlot, MeanPlot], 'Median','Mean')
                
            elseif strcmpi(PopulationSetting,'Single Cell') %Only plot quantiles in Single-Cell mode
                semilogy(Time,max(UQ,0.000001),'r--','LineWidth',0.75)
                semilogy(Time,max(LQ,0.000001),'r--','LineWidth',0.75)
            end
            hold off
        end
        font_ax(sprintf('%s',VarNames{i}),'Time (h)',MedianTable.Properties.VariableUnits{i},10,'bold',2.0,0)
    end
    
    %Replication and VRO Species
    figure
    sgtitle(sprintf('Viral Replication Organelle Species at an MOI of %s',MOI),'FontSize',12,'FontWeight','bold')
    for i = 25:31
        subplot(2,4,i-24)
        Median = table2array(MedianTable(:,{VarNames{i}}));
        UQ = table2array(UpperQuantileTable(:,{VarNames{i}}));
        LQ = table2array(LowerQuantileTable(:,{VarNames{i}}));
        Mean = table2array(MeanTable(:,{VarNames{i}}));
        if strcmpi(PlotType,'linear') == 1
            hold on
            MedianPlot=plot(Time,Median,'r-','LineWidth',2);
            if strcmpi(PopulationSetting,'Population') %Population mode plots the mean as well
                MeanPlot=plot(Time,Mean,'r:','LineWidth',2);
                legend([MedianPlot, MeanPlot], 'Median','Mean')
                
            elseif strcmpi(PopulationSetting,'Single Cell') %Only plot quantiles in Single-Cell mode
                plot(Time,UQ,'r--','LineWidth',0.75)
                plot(Time,LQ,'r--','LineWidth',0.75)
            end
            hold off
        elseif strcmpi(PlotType,'semilog') == 1
            MedianPlot=semilogy(Time,max(Median,0.000001),'r-','LineWidth',2);
            hold on
            if strcmpi(PopulationSetting,'Population') %Population mode plots the mean as well
                MeanPlot=semilogy(Time,max(Mean,0.000001),'r:','LineWidth',2);
                legend([MedianPlot, MeanPlot], 'Median','Mean')
                
            elseif strcmpi(PopulationSetting,'Single Cell') %Only plot quantiles in Single-Cell mode
                semilogy(Time,max(UQ,0.000001),'r--','LineWidth',0.75)
                semilogy(Time,max(LQ,0.000001),'r--','LineWidth',0.75)
            end
            hold off
        end
        font_ax(sprintf('%s',VarNames{i}),'Time (h)',MedianTable.Properties.VariableUnits{i},10,'bold',2.0,0)
    end
    
    %Virion Assembly
    figure
    sgtitle(sprintf('Virion Capsid Assembly Species at an MOI of %s',MOI),'FontSize',12,'FontWeight','bold')
    for i = 32:42
        subplot(2,11,i-31)
        Median = table2array(MedianTable(:,{VarNames{i}}));
        UQ = table2array(UpperQuantileTable(:,{VarNames{i}}));
        LQ = table2array(LowerQuantileTable(:,{VarNames{i}}));
        Mean = table2array(MeanTable(:,{VarNames{i}}));
        if strcmpi(PlotType,'linear') == 1
            hold on
            MedianPlot=plot(Time,Median,'r-','LineWidth',2);
            if strcmpi(PopulationSetting,'Population') %Population mode plots the mean as well
                MeanPlot=plot(Time,Mean,'r:','LineWidth',2);
                legend([MedianPlot, MeanPlot], 'Median','Mean')
                
            elseif strcmpi(PopulationSetting,'Single Cell') %Only plot quantiles in Single-Cell mode
                plot(Time,UQ,'r--','LineWidth',0.75)
                plot(Time,LQ,'r--','LineWidth',0.75)
            end
            hold off
        elseif strcmpi(PlotType,'semilog') == 1
            MedianPlot=semilogy(Time,max(Median,0.000001),'r-','LineWidth',2);
            hold on
            if strcmpi(PopulationSetting,'Population') %Population mode plots the mean as well
                MeanPlot=semilogy(Time,max(Mean,0.000001),'r:','LineWidth',2);
                legend([MedianPlot, MeanPlot], 'Median','Mean')
                
            elseif strcmpi(PopulationSetting,'Single Cell') %Only plot quantiles in Single-Cell mode
                semilogy(Time,max(UQ,0.000001),'r--','LineWidth',0.75)
                semilogy(Time,max(LQ,0.000001),'r--','LineWidth',0.75)
            end
            hold off
        end
        font_ax(sprintf('%s',VarNames{i}),'Time (h)',MedianTable.Properties.VariableUnits{i},10,'bold',2.0,0)
    end
    for i = 44:53
        subplot(2,11,i-31)
        Median = table2array(MedianTable(:,{VarNames{i}}));
        UQ = table2array(UpperQuantileTable(:,{VarNames{i}}));
        LQ = table2array(LowerQuantileTable(:,{VarNames{i}}));
        Mean = table2array(MeanTable(:,{VarNames{i}}));
        if strcmpi(PlotType,'linear') == 1
            hold on
            MedianPlot=plot(Time,Median,'r-','LineWidth',2);
            if strcmpi(PopulationSetting,'Population') %Population mode plots the mean as well
                MeanPlot=plot(Time,Mean,'r:','LineWidth',2);
                legend([MedianPlot, MeanPlot], 'Median','Mean')
                
            elseif strcmpi(PopulationSetting,'Single Cell') %Only plot quantiles in Single-Cell mode
                plot(Time,UQ,'r--','LineWidth',0.75)
                plot(Time,LQ,'r--','LineWidth',0.75)
            end
            hold off
        elseif strcmpi(PlotType,'semilog') == 1
            MedianPlot=semilogy(Time,max(Median,0.000001),'r-','LineWidth',2);
            hold on
            if strcmpi(PopulationSetting,'Population') %Population mode plots the mean as well
                MeanPlot=semilogy(Time,max(Mean,0.000001),'r:','LineWidth',2);
                legend([MedianPlot, MeanPlot], 'Median','Mean')
                
            elseif strcmpi(PopulationSetting,'Single Cell') %Only plot quantiles in Single-Cell mode
                semilogy(Time,max(UQ,0.000001),'r--','LineWidth',0.75)
                semilogy(Time,max(LQ,0.000001),'r--','LineWidth',0.75)
            end
            hold off
        end
        font_ax(sprintf('%s',VarNames{i}),'Time (h)',MedianTable.Properties.VariableUnits{i},10,'bold',2.0,0)
    end
    
    %Empty vs Filled Virions
    figure
    MedianFilledOutput = table2array(MedianTable(:,{'Virions'}));
    MedianEmptyOutput = table2array(MedianTable(:,{'Empty Provirions'}));
    UQFilledOutput = table2array(UpperQuantileTable(:,{'Virions'}));
    UQEmptyOutput = table2array(UpperQuantileTable(:,{'Empty Provirions'}));
    LQFilledOutput = table2array(LowerQuantileTable(:,{'Virions'}));
    LQEmptyOutput = table2array(LowerQuantileTable(:,{'Empty Provirions'}));
    MeanFilledOutput = table2array(MeanTable(:,{'Virions'}));
    MeanEmptyOutput = table2array(MeanTable(:,{'Empty Provirions'}));
    
    if strcmpi(PlotType,'linear') == 1
        hold on
        filledPlot = plot(Time,MedianFilledOutput,'r-','LineWidth',2);
        emptyPlot = plot(Time,MedianEmptyOutput,'b-','LineWidth',2);
        LegendPlots = [filledPlot, emptyPlot];
        LegendLabels = {'Filled Virions','Empty Virions'};
        
        if strcmpi(PopulationSetting,'Population') %Population mode plots the mean as well
            MeanFilledPlot=plot(Time,MeanFilledOutput,'r:','LineWidth',2);
            MeanEmptyPlot=plot(Time,MeanEmptyOutput,'b:','LineWidth',2);
            LegendPlots = [filledPlot,emptyPlot,MeanFilledPlot,MeanEmptyPlot];
            LegendLabels = {'Median Filled Virions','Median Empty Virions','Mean Filled Virions','Mean Empty Virions'};
            
        elseif strcmpi(PopulationSetting,'Single Cell') %Only plot quantiles in Single-Cell mode
            plot(Time,UQFilledOutput,'r--','LineWidth',0.75)
            plot(Time,LQFilledOutput,'r--','LineWidth',0.75)
            
            plot(Time,UQEmptyOutput,'b--','LineWidth',0.75)
            plot(Time,LQEmptyOutput,'b--','LineWidth',0.75)
        end
        
        legend(LegendPlots,LegendLabels)
        hold off
    elseif strcmpi(PlotType,'semilog') == 1
        filledPlot = semilogy(Time,max(MedianFilledOutput,0.000001),'r-','LineWidth',2);
        hold on
        emptyPlot = semilogy(Time,max(MedianEmptyOutput,0.000001),'b-','LineWidth',2);
        LegendPlots = [filledPlot, emptyPlot];
        LegendLabels = {'Filled Virions','Empty Virions'};
        
        if strcmpi(PopulationSetting,'Population') %Population mode plots the mean as well
            MeanFilledPlot=semilogy(Time,max(MeanFilledOutput,0.000001),'r:','LineWidth',2);
            MeanEmptyPlot=semilogy(Time,max(MeanEmptyOutput,0.000001),'b:','LineWidth',2);
            LegendPlots = [filledPlot,emptyPlot,MeanFilledPlot,MeanEmptyPlot];
            LegendLabels = {'Median Filled Virions','Median Empty Virions','Mean Filled Virions','Mean Empty Virions'};
            
        elseif strcmpi(PopulationSetting,'Single Cell') %Only plot quantiles in Single-Cell mode
            semilogy(Time,max(UQFilledOutput,0.000001),'r--','LineWidth',0.75)
            semilogy(Time,max(LQFilledOutput,0.000001),'r--','LineWidth',0.75)
            
            semilogy(Time,max(UQEmptyOutput,0.000001),'b--','LineWidth',0.75)
            semilogy(Time,max(LQEmptyOutput,0.000001),'b--','LineWidth',0.75)
        end
        
        legend(LegendPlots,LegendLabels)
        hold off
    end
    font_ax(sprintf('Infectious Viral Progeny vs Empty Provions at an MOI of %s',MOI),'Time (h)','nM',10,'bold',2.0,0)
    
    %Host-viral interaction
    figure
    sgtitle(sprintf('Host Anti-viral Response at an MOI of %s',MOI),'FontSize',12,'FontWeight','bold')
    for i = 55:56
        subplot(1,2,i-54)
        Median = table2array(MedianTable(:,{VarNames{i}}));
        UQ = table2array(UpperQuantileTable(:,{VarNames{i}}));
        LQ = table2array(LowerQuantileTable(:,{VarNames{i}}));
        Mean = table2array(MeanTable(:,{VarNames{i}}));
        if strcmpi(PlotType,'linear') == 1
            hold on
            MedianPlot=plot(Time,Median,'r-','LineWidth',2);
            if strcmpi(PopulationSetting,'Population') %Population mode plots the mean as well
                MeanPlot=plot(Time,Mean,'r:','LineWidth',2);
                legend([MedianPlot,MeanPlot],'Median', 'Mean')
                
            elseif strcmpi(PopulationSetting,'Single Cell') %Only plot quantiles in Single-Cell mode
                plot(Time,UQ,'r--','LineWidth',0.75)
                plot(Time,LQ,'r--','LineWidth',0.75)
            end
            hold off
        elseif strcmpi(PlotType,'semilog') == 1
            MedianPlot=semilogy(Time,max(Median,0.000001),'r-','LineWidth',2);
            hold on
            if strcmpi(PopulationSetting,'Population') %Population mode plots the mean as well
                MeanPlot=semilogy(Time,max(Mean,0.000001),'r:','LineWidth',2);
                legend([MedianPlot,MeanPlot],'Median', 'Mean')
                
            elseif strcmpi(PopulationSetting,'Single Cell') %Only plot quantiles in Single-Cell mode
                semilogy(Time,max(UQ,0.000001),'r--','LineWidth',0.75)
                semilogy(Time,max(LQ,0.000001),'r--','LineWidth',0.75)
            end
            hold off
        end
        font_ax(sprintf('%s',VarNames{i}),'Time (h)',MedianTable.Properties.VariableUnits{i},10,'bold',2.0,0)
    end
    
    %Summary species
    figure
    sgtitle(sprintf('Summary Species at an MOI of %s',MOI),'FontSize',12,'FontWeight','bold')
    subplot(1,3,1)
    MedianTotPosOutput = table2array(MedianTable(:,{'Total +ssRNA'}));
    MedianTotNegOutput = table2array(MedianTable(:,{'Total -ssRNA'}));
    
    UQTotPosOutput = table2array(UpperQuantileTable(:,{'Total +ssRNA'}));
    UQTotNegOutput = table2array(UpperQuantileTable(:,{'Total -ssRNA'}));
    
    LQTotPosOutput = table2array(LowerQuantileTable(:,{'Total +ssRNA'}));
    LQTotNegOutput = table2array(LowerQuantileTable(:,{'Total -ssRNA'}));
    
    MeanTotPosOutput = table2array(MeanTable(:,{'Total +ssRNA'}));
    MeanTotNegOutput = table2array(MeanTable(:,{'Total -ssRNA'}));
    
    if strcmpi(PlotType,'linear') == 1
        hold on
        TotPosPlot = plot(Time,MedianTotPosOutput,'r-','LineWidth',2);
        TotNegPlot = plot(Time,MedianTotNegOutput,'b-','LineWidth',2);
        LegendPlots = [TotPosPlot,TotNegPlot];
        LegendLabels = {'+ssRNA', '-ssRNA'};
        
        if strcmpi(PopulationSetting,'Population') %Population mode plots the mean as well
            TotPosMeanPlot = plot(Time,MeanTotPosOutput,'r:','LineWidth',2);
            TotNegMeanPlot = plot(Time,MeanTotNegOutput,'b:','LineWidth',2);
            LegendPlots = [TotPosPlot,TotNegPlot,TotPosMeanPlot,TotNegMeanPlot];
            LegendLabels = {'Median +ssRNA','Median -ssRNA', 'Mean +ssRNA','Mean -ssRNA'};
            
        elseif strcmpi(PopulationSetting,'Single Cell') %Only plot quantiles in Single-Cell mode
            plot(Time,UQTotPosOutput,'r--','LineWidth',0.75)
            plot(Time,LQTotPosOutput,'r--','LineWidth',0.75)
            
            plot(Time,UQTotNegOutput,'b--','LineWidth',0.75)
            plot(Time,LQTotNegOutput,'b--','LineWidth',0.75)
        end
        
        legend(LegendPlots, LegendLabels)
        hold off
    elseif strcmpi(PlotType,'semilog') == 1
        TotPosPlot=semilogy(Time,max(MedianTotPosOutput,0.000001),'r-','LineWidth',2);
        hold on
        TotNegPlot=semilogy(Time,max(MedianTotNegOutput,0.000001),'b-','LineWidth',2);
        LegendPlots = [TotPosPlot,TotNegPlot];
        LegendLabels = {'+ssRNA', '-ssRNA'};
        
        if strcmpi(PopulationSetting,'Population') %Population mode plots the mean as well
            TotPosMeanPlot = semilogy(Time,max(MeanTotPosOutput,0.000001),'r:','LineWidth',2);
            TotNegMeanPlot = semilogy(Time,max(MeanTotNegOutput,0.000001),'b:','LineWidth',2);
            LegendPlots = [TotPosPlot,TotNegPlot,TotPosMeanPlot,TotNegMeanPlot];
            LegendLabels = {'Median +ssRNA','Median -ssRNA', 'Mean +ssRNA','Mean -ssRNA'};
            
        elseif strcmpi(PopulationSetting,'Single Cell') %Only plot quantiles in Single-Cell mode
            semilogy(Time,max(UQTotPosOutput,0.000001),'r--','LineWidth',0.75)
            semilogy(Time,max(LQTotPosOutput,0.000001),'r--','LineWidth',0.75)
            
            semilogy(Time,max(UQTotNegOutput,0.000001),'b--','LineWidth',0.75)
            semilogy(Time,max(LQTotNegOutput,0.000001),'b--','LineWidth',0.75)
        end
        
        legend(LegendPlots, LegendLabels)
        hold off
    end
    font_ax('Total +ssRNA vs Total -ssRNA','Time (h)','nM',10,'bold',2.0,0)
    
    for i = 59:60
        subplot(1,3,i-57)
        Median = table2array(MedianTable(:,{VarNames{i}}));
        UQ = table2array(UpperQuantileTable(:,{VarNames{i}}));
        LQ = table2array(LowerQuantileTable(:,{VarNames{i}}));
        Mean = table2array(MeanTable(:,{VarNames{i}}));
        if strcmpi(PlotType,'linear') == 1
            hold on
            MedianPlot=plot(Time,Median,'r-','LineWidth',2);
            if strcmpi(PopulationSetting,'Population') %Population mode plots the mean as well
                MeanPlot=plot(Time,Mean,'r:','LineWidth',2);
                legend([MedianPlot,MeanPlot],'Median', 'Mean')
                
            elseif strcmpi(PopulationSetting,'Single Cell') %Only plot quantiles in Single-Cell mode
                plot(Time,UQ,'r--','LineWidth',0.75)
                plot(Time,LQ,'r--','LineWidth',0.75)
            end
            hold off
        elseif strcmpi(PlotType,'semilog') == 1
            MedianPlot=semilogy(Time,max(Median,0.000001),'r-','LineWidth',2);
            hold on
            if strcmpi(PopulationSetting,'Population') %Population mode plots the mean as well
                MeanPlot=semilogy(Time,max(Mean,0.000001),'r:','LineWidth',2);
                legend([MedianPlot,MeanPlot],'Median', 'Mean')
                
            elseif strcmpi(PopulationSetting,'Single Cell') %Only plot quantiles in Single-Cell mode
                semilogy(Time,max(UQ,0.000001),'r--','LineWidth',0.75)
                semilogy(Time,max(LQ,0.000001),'r--','LineWidth',0.75)
            end
            hold off
        end
        font_ax(sprintf('%s',VarNames{i}),'Time (h)',MedianTable.Properties.VariableUnits{i},10,'bold',2.0,0)
    end
    
else
    %Individual plots
    for j = 1:length(PlotOutputs)
        CustomTable = MedianTable(:,PlotOutputs(j));
        Median = table2array(MedianTable(:,PlotOutputs(j)));
        UQ = table2array(UpperQuantileTable(:,PlotOutputs(j)));
        LQ = table2array(LowerQuantileTable(:,PlotOutputs(j)));
        Mean = table2array(MeanTable(:,PlotOutputs(j)));
        figure
        if strcmpi(PlotType,'linear') == 1
            hold on
            MedianPlot=plot(Time,Median,'r-','LineWidth',2);
            if strcmpi(PopulationSetting,'Population') %Population mode plots the mean as well
                MeanPlot=plot(Time,Mean,'r:','LineWidth',2);
                legend([MedianPlot,MeanPlot],'Median', 'Mean')
                
            elseif strcmpi(PopulationSetting,'Single Cell') %Only plot quantiles in Single-Cell mode
                plot(Time,UQ,'r--','LineWidth',0.75)
                plot(Time,LQ,'r--','LineWidth',0.75)
            end
            hold off
        elseif strcmpi(PlotType,'semilog') == 1
            hold on
            MedianPlot=semilogy(Time,max(Median,0.000001),'r-','LineWidth',2);
            if strcmpi(PopulationSetting,'Population') %Population mode plots the mean as well
                MeanPlot=semilogy(Time,max(Mean,0.000001),'r:','LineWidth',2);
                legend([MedianPlot,MeanPlot],'Median', 'Mean')
                
            elseif strcmpi(PopulationSetting,'Single Cell') %Only plot quantiles in Single-Cell mode
                semilogy(Time,max(UQ,0.000001),'r--','LineWidth',0.75)
                semilogy(Time,max(LQ,0.000001),'r--','LineWidth',0.75)
            end
            hold off
        end
        font_ax(sprintf('%s at an MOI of %s',PlotOutputs{j},MOI),'Time (h)',CustomTable.Properties.VariableUnits,10,'bold',2.0,0)
    end
end

end

function [SensitivityAnalysis] = SensitivityAnalysisfunc(CVB3ODE,LabeledConstants,LabeledInitVals,SensitivityAnalysisOutput,OtherSpecies,ScalingFactor,MaxScalingOrder,IFNSwitch,VirResponse,IFNStimulation,IFNStimulationTime,MaxTime,Options)
%Function: Runs sensitivity analysis on the model
%
%INPUTS:
    %LabeledConstants: Cell array of constant labels and values
    %LabeledInitVals: Cell array of initial condition labels and values
    %SensitivityAnalysisOutput: Indicates the model species that is evaluated during sensitivity analysis.
    %OtherSpecies: Vector of strings of species to study if the 'Other' SensitivityAnalysisOutput is selected.
    %ScalingFactor: The factor by which each parameter is scaled during sensitivity analysis
    %MaxScalingOrder: The integer absolute value of the maximum order of magnitude change to test
    %IFNSwitch: 'on' to enable IFN response, otherwise it is disabled.
    %IFNStimulation: Indicates if IFN pre-stimulation is simulated.
    %IFNStimulationTime: If IFNStimulation is enabled, indicates the time at which exogenous IFN stimulation occurs. Negative in the case of pre-stimulation.
    %MaxTime: Maximum time for the solver in hours. Used for plotting.
    %Options: Desired optional settings for the ODE solver.
%  
%OUTPUTS:
    %SensitivityAnalysis: A table containing the final values from the model run
        
%% Set-up for the sensitivity analysis    

%Sets the scaling factor that we vary each parameter by:
Scalar = ScalingFactor;

%Pulls Constants and InitVals from their labeled cell arrays
Constants = LabeledConstants{:,:};
InitVals = LabeledInitVals{:,:};
ConstantLabels = LabeledConstants.Properties.RowNames;
InitValLabels = LabeledInitVals.Properties.RowNames;

%These are the labels of potentially variable initial conditions to test:
InitValLabelVec = {'uCVB3' 'Defective uCVB3' 'uDAF' 'uCAR' 'Viral Ribosomes' 'Host Ribosomes' 'ISG Protein'};

%Pre-defining quick options for OutputIndex:
Positive_Strands = {'R p endo' 'Defective R p endo' 'R p cyt' 'Defective R p cyt' 'T c' 'R p VRO' 'RNA-Bound Pentamer' 'Virion' 'P2Filled' 'P3Filled' 'P4Filled' 'P5Filled' 'P6Filled' 'P7Filled' 'P8Filled' 'P9Filled' 'P10Filled' 'P11Filled'};
Negative_Strands = {'R n cyt' 'R n VRO'};
dsRNA = {'R Ip VRO' 'R In VRO'};
Polyproteins = {'Protease'};
Virion = {'Virion'};
EmptyProvirion = {'Empty Provirion'};
    
%Assigns OutputIndex based on the SensAnalysis input. This is a vector of indices indicating the desired species of study.
if strcmpi(SensitivityAnalysisOutput,'Plus RNA')
    OutputIndex = Positive_Strands;
    Title = 'Comprehensive Sensitivity Analysis: Log2 Fold Changes in Positive Strand RNA Concentration at %0.1f hpi';
elseif strcmpi(SensitivityAnalysisOutput,'Minus RNA')
    OutputIndex = Negative_Strands;
    Title = 'Comprehensive Sensitivity Analysis: Log2 Fold Changes in Negative Strand RNA Concentration at %0.1f hpi';
elseif strcmpi(SensitivityAnalysisOutput,'dsRNA')
    OutputIndex = dsRNA;
    Title = 'Comprehensive Sensitivity Analysis: Log2 Fold Changes in Double Strand RNA Concentration at %0.1f hpi';
elseif strcmpi(SensitivityAnalysisOutput,'RNA Ratio')
    OutputIndex = Positive_Strands;
    Title = 'Comprehensive Sensitivity Analysis: Log2 Fold Changes in Positive/Negative Strand RNA Concentration Ratio at %0.1f hpi';
elseif strcmpi(SensitivityAnalysisOutput,'Polyprotein')
    OutputIndex = Polyproteins;
    Title = 'Comprehensive Sensitivity Analysis: Log2 Fold Changes in Polyprotein Concentration at %0.1f hpi';
elseif strcmpi(SensitivityAnalysisOutput,'Virion')
    OutputIndex = Virion;    
    Title = 'Comprehensive Sensitivity Analysis: Log2 Fold Changes in Virion Concentration at %0.1f hpi';
elseif strcmpi(SensitivityAnalysisOutput,'Empty Provirion')
    OutputIndex = EmptyProvirion;
    Title = 'Comprehensive Sensitivity Analysis: Log2 Fold Changes in Empty Capsid Concentration at %0.1f hpi';
elseif strcmpi(SensitivityAnalysisOutput,'Other')
    OutputIndex = OtherSpecies;
    Title = 'Comprehensive Sensitivity Analysis: Log2 Fold Changes of Custom Input Concentration at %0.1f hpi';
else
    fprintf('\nError: Invalid SensitivityAnalysisOutput Input.\n')
    return
end

%% Sensitivity analysis:

SensMat = zeros(1+2*MaxScalingOrder,length(Constants)+length(InitValLabelVec)); %Initializes the matrix (Excludes volume conversion constants)

for j = 1:length(Constants) + length(InitValLabelVec)
    
    fprintf('\n %2d \n',j) %Displays index for tracking of error messages
    
    for i = 1:(1+2*MaxScalingOrder)
        
        fprintf('%1d',i) %Displays index for tracking
        
        %Conditional to alter hill coefficient analysis. Order of magnitude changes are unrealistic and result in solver failure or large delays, so integer/scaler changes are used
        if j <= length(Constants) && j == find(strcmpi(LabeledConstants.Properties.RowNames,'Hill_Constant'))
            HillConstantIndex = j;
            if i == 1
                OriginalValue = Constants(j); %Saves original value for resetting later
                Constants(j) = OriginalValue / 2^MaxScalingOrder; %Brings down to minimum value
            elseif i <= MaxScalingOrder
                Constants(j) = Constants(j) * 2; %Scales each number below the median by 2 up to the original value
            else
                Constants(j) = Constants(j) + 1; %Increases by one integer value
            end 
        elseif j <= length(Constants) %This condition is to manipulate the values of all constants other than the Hill coefficient
            if i == 1
                OriginalValue = Constants(j); %Saves original value for resetting later
                Constants(j) = OriginalValue / Scalar^(MaxScalingOrder); %Brings down to minimum value
            else
                Constants(j) = Constants(j) * Scalar; %Increases by an order of magnitude
            end
        else %This condition is to manipulate the value of initial conditions
            if i == 1
                OriginalValue = LabeledInitVals{InitValLabelVec{j-length(Constants)},:}; %Saves original value for resetting later
                ValueIndex = find(strcmpi(LabeledInitVals.Properties.RowNames,InitValLabelVec{j-length(Constants)})); %Saves original value index for resetting later
                InitVals(ValueIndex) = OriginalValue / Scalar^(MaxScalingOrder); %Brings down to minimum value
            else
                InitVals(ValueIndex) = InitVals(ValueIndex) * Scalar; %Increases by an order of magnitude
            end
        end
        
        [~,Solutions] = ode15s(@(t,y)CVB3ODE(t,y,Constants,IFNSwitch,VirResponse,IFNStimulation,IFNStimulationTime),[0 MaxTime],InitVals,Options); %Solving the ODE
       
        LabeledSolutions = table(Solutions(end,:)','RowNames',InitValLabels,'VariableNames',{'Value'}); %Adding labels to the solutions matrix. Only uses end values.
        
        for k = 1:length(OutputIndex) %Takes output indices and sums end values in each species
            Value = LabeledSolutions{OutputIndex(k),:};
            SensMat(i,j) = SensMat(i,j) + Value;
        end        
        if strcmpi(SensitivityAnalysisOutput,'RNA Ratio') %Necessary to do Sensitivity analysis on the RNA ratio
            Denominator = 0;
            for l = 1:length(Negative_Strands)
                Value = LabeledSolutions{Negative_Strands(l),:};
                Denominator = Denominator + Value;
            end
            SensMat(i,j) = SensMat(i,j)/Denominator; %Creates the ratio
        end
        
        if i == (1+2*MaxScalingOrder) %For resetting original value when max value has been reached
            if j <= length(Constants) %Resets original value for constants
                Constants(j) = OriginalValue;
            else %Resets original value for initial conditions
                InitVals(ValueIndex) = OriginalValue;
            end
        end
 
    end
end

%Min and Max values of the solution in question. Used for colormap axis.
MaxSolution = max(max(SensMat)); 
MinSolution = min(min(SensMat));
UnchangedSolution = SensMat(1+MaxScalingOrder,1); %Value if the model is run without changing any parameters.

SensMat = flipud(real(SensMat)); %Eliminates imaginary numbers and flips the matrix for the later heatmap function
SensMatNorm = log2(SensMat./UnchangedSolution); %Sets the value at original conditions as 0 and puts others relative to that

fprintf('\nThe Minimum Value is %3.2e\n',MinSolution) %Displays minimum of the matrix
fprintf('The Maximum Value is %3.2e\n',MaxSolution) %Displays maximum of the matrix
fprintf('The Average Value is %3.2e\n',UnchangedSolution) %Displays the average value of the matrix

%% Heat Map Generation

%Generates string labels for the heatmap rows based on MaxScalingOrder
RowLabels = cell(1,1+2*MaxScalingOrder); RowMinValue = Scalar^-MaxScalingOrder;
for i = 1:1+2*MaxScalingOrder
    RowLabels{i}= num2str(RowMinValue);
    RowMinValue = Scalar * RowMinValue;
end

%Generates string labels for the rows of the Hill Constant heatmap based on MaxScalingOrder
RowLabelsHillConstant = cell(1,1+2*MaxScalingOrder); RowHillConstantValue = 1/2^MaxScalingOrder;
for i = 1:1+2*MaxScalingOrder
    RowLabelsHillConstant{i}= num2str(RowHillConstantValue);
    if i <= MaxScalingOrder
        RowHillConstantValue = RowHillConstantValue * 2;
    else
        RowHillConstantValue = RowHillConstantValue + 1;
    end
end

%Determines the color axis settings- selects which relative difference is greater for caxislimit
if abs(MaxSolution/(UnchangedSolution+0.000000000000001)) >= abs(UnchangedSolution/(MinSolution+0.000000000000001))
    caxislimit = MaxSolution/(UnchangedSolution+0.000000000000001);
else
    caxislimit = UnchangedSolution/(MinSolution+0.000000000000001);
end

%Creates row and column labels for the heatmap
RowLabels = fliplr(RowLabels); %Flips the row label vector horizontally so it aligns with the heatmap data
RowLabelsHillConstant = fliplr(RowLabelsHillConstant); %Flips the row label vector horizontally so it aligns with the heatmap data
ColLabels = strrep([ ConstantLabels' InitValLabelVec ],'_',' '); %Creates vector of string labels for the heatmap columns

%Vector for the heatmap color bar
Colors = [.3137 .3647 .4549; .3333 .4706 .6235; .3922 .5686 .7098; .4902 .6353 .7686; .6157 .7255 .8314; ...
    .9647 .9647 .9686; .9412 .7059 .5373; .8902 .6157 .4667; .8353 .5333 .4039; .7176 .3843 .3294; .5020 .3373 .3255];

%Creates a trimmed version without the middle row of all unchanged solutions
SensMatNorm(1+MaxScalingOrder,:) = [];
RowLabels(:,1+MaxScalingOrder) = [];
RowLabelsHillConstant(:,1+MaxScalingOrder) = [];

%Alters main heatmap and labels by removing Hill Constant for its own subplot with a separate y-axis
HillConstantSensMatNorm = SensMatNorm(:,HillConstantIndex);
SensMatNorm(:,HillConstantIndex) = [];
ColLabelHillConstant = ColLabels(HillConstantIndex);
ColLabels(HillConstantIndex) = [];

%Heatmap plot (Without center row of 1x)
figure
subplot(1,10,1:9)
    heatmap(ColLabels,RowLabels,SensMatNorm,'Colormap',Colors,'Title',sprintf(Title,MaxTime),'XLabel','Constant Name','YLabel','Multiplication Factor','MissingDataColor',[0 0 0],'MissingDataLabel','No Data')
    caxis(round([-log2(caxislimit) log2(caxislimit)],0))
    colorbar('off')
subplot(1,10,10)
    heatmap(ColLabelHillConstant,RowLabelsHillConstant,HillConstantSensMatNorm,'Colormap',Colors,'XLabel','Constant Name','YLabel','Multiplication Factor (< Median), Summand (> Median)','MissingDataColor',[0 0 0],'MissingDataLabel','No Data')
    caxis(round([-log2(caxislimit) log2(caxislimit)],0))

%Assign heatmap data to results table
SensitivityAnalysis = array2table(SensMatNorm,'VariableNames',ColLabels,'RowNames',RowLabels);

end